<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarFleet ERP - Fleet Management System (Back4App)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Back4App Parse SDK -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>

    <script>
        // Initialize Back4App Parse
        Parse.initialize(
            "R8pocmtBNX8EekAQthaMafp6Qq40L4tGlqvB7nQL", // Application ID
            "jHwpYA0QPz2eSIKlQHnUMBg4hGWmVZ675MWZWoEJ"  // JavaScript Key
        );
        Parse.serverURL = 'https://parseapi.back4app.com/';

        console.log('Back4App Parse initialized successfully');
    </script>




    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #3b82f6;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --light: #f3f4f6;
            --dark: #1f2937;
            --gray: #6b7280;
            --light-gray: #e5e7eb;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --secondary: #60a5fa;
            --accent: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --success: #34d399;
            --light: #1f2937;
            --dark: #f9fafb;
            --gray: #9ca3af;
            --light-gray: #374151;
        }

        [data-theme="dark"] body {
            background-color: var(--light);
            color: var(--dark);
        }

        [data-theme="dark"] .sidebar {
            background: var(--primary);
        }

        [data-theme="dark"] .card {
            background-color: var(--light);
            color: var(--dark);
        }

        [data-theme="dark"] .topbar {
            background-color: var(--dark);
            color: var(--light);
        }

        [data-theme="dark"] .search-bar {
            background-color: var(--light-gray);
        }

        [data-theme="dark"] .data-table th {
            background-color: var(--light-gray);
        }

        [data-theme="dark"] .data-table tr:hover {
            background-color: var(--light-gray);
        }

        [data-theme="dark"] .modal-content {
            background-color: var(--dark);
            color: var(--light);
        }

        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group select,
        [data-theme="dark"] .form-group textarea {
            background-color: var(--light);
            color: var(--dark);
            border-color: var(--light-gray);
        }

        [data-theme="dark"] .form-group input:focus,
        [data-theme="dark"] .form-group select:focus,
        [data-theme="dark"] .form-group textarea:focus {
            border-color: var(--primary);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9fafb;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--primary);
            color: white;
            transition: all 0.3s ease;
        }

        .sidebar.hidden {
            width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background-color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-item:hover,
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .menu-toggle:hover {
            background-color: var(--light-gray);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--light);
            border-radius: 6px;
            padding: 8px 15px;
            width: 300px;
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            padding: 0 10px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-selector {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .user-selector:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.5);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .content {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .stat-card {
            display: flex;
            flex-direction: column;
        }

        .stat-card h3 {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .change {
            margin-top: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .change.positive {
            color: var(--success);
        }

        .change.negative {
            color: var(--danger);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background-color: var(--light);
            font-weight: 600;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .status.active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status.maintenance {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status.inactive {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .status.info {
            /* Added for scheduled routes */
            background-color: #bfdbfe;
            color: #1e40af;
        }

        .status-select {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid var(--light-gray);
            background-color: white;
            cursor: pointer;
            appearance: none;
            /* Remove default select arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2C114.7L154.7%2C247.1c-2.4%2C2.4-5.8%2C4.1-9.8%2C4.1s-7.4-1.7-9.8-4.1L5.4%2C114.7c-4.1-4.1-4.1-10.7%2C0-14.8l14.8-14.8c4.1-4.1%2C10.7-4.1%2C14.8%2C0l118%2C118l118-118c4.1-4.1%2C10.7-4.1%2C14.8%2C0l14.8%2C14.8C291.1%2C104%2C291.1%2C110.6%2C287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px;
            padding-right: 25px;
            /* Make space for the arrow */
        }

        .status-select.active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-select.maintenance {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-select.inactive {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .status-select.info {
            /* Added for scheduled routes */
            background-color: #bfdbfe;
            color: var(--primary);
        }

        .btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--light-gray);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            color: var(--gray);
        }

        .action-btn:hover {
            color: var(--primary);
            background-color: var(--light);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            /* Add this line */
            overflow-y: auto;
            /* Add this line */
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            /* For loading overlay */
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: var(--danger);
        }

        .form-group .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .tab-container {
            margin-top: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: white;
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeIn 0.3s forwards;
        }

        .toast.success {
            border-left: 5px solid var(--success);
        }

        .toast.error {
            border-left: 5px solid var(--danger);
        }

        .toast.warning {
            border-left: 5px solid var(--warning);
        }

        .toast.info {
            border-left: 5px solid var(--primary);
        }

        .toast i {
            font-size: 1.2rem;
        }

        .toast.success i {
            color: var(--success);
        }

        .toast.error i {
            color: var(--danger);
        }

        .toast.warning i {
            color: var(--warning);
        }

        .toast.info i {
            color: var(--primary);
        }

        .toast .close-toast {
            margin-left: auto;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--gray);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 10;
            display: none;
            /* Hidden by default */
        }

        .loading-spinner {
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom Confirmation Dialog */
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            align-items: center;
            justify-content: center;
        }

        .confirmation-content {
            background-color: white;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .confirmation-content h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .confirmation-content p {
            margin-bottom: 25px;
            color: var(--gray);
        }

        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* File Upload Styles */
        .file-upload-container {
            border: 2px dashed var(--light-gray);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
            transition: border-color 0.3s ease;
        }

        .file-upload-container:hover {
            border-color: var(--primary);
        }

        .file-upload-container input[type="file"] {
            display: none;
        }

        .file-upload-container p {
            margin: 0;
            color: var(--gray);
        }

        .file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .file-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--light);
        }

        .file-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .file-preview .remove-file {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .file-preview.invoice::before {
            content: "PDF";
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--danger);
            color: white;
            padding: 2px 5px;
            font-size: 0.7rem;
            border-bottom-right-radius: 5px;
        }

        .file-preview.image::before {
            content: "IMG";
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--accent);
            color: white;
            padding: 2px 5px;
            font-size: 0.7rem;
            border-bottom-right-radius: 5px;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .topbar {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .search-bar {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-truck fa-2x"></i>
                <h2>StarFleet ERP</h2>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-tab="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-tab="vehicles">
                    <i class="fas fa-truck"></i>
                    <span>Vehicles</span>
                </div>
                <div class="menu-item" data-tab="drivers">
                    <i class="fas fa-user"></i>
                    <span>Drivers</span>
                </div>
                <div class="menu-item" data-tab="maintenance">
                    <i class="fas fa-tools"></i>
                    <span>Maintenance</span>
                </div>
                <div class="menu-item" data-tab="breakdowns">
                    <i class="fas fa-car-crash"></i>
                    <span>Breakdowns</span>
                </div>
                <div class="menu-item" data-tab="routes">
                    <i class="fas fa-route"></i>
                    <span>Routes</span>
                </div>
                <div class="menu-item" data-tab="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </div>
                <div class="menu-item" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar -->
            <div class="topbar">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search...">
                </div>
                <div class="user-profile">
                    <div class="notifications">
                        <i class="fas fa-bell"></i>
                    </div>
                    <select id="userSelector" class="user-selector">
                        <option value="esteban">Esteban</option>
                        <option value="albert">Albert</option>
                        <option value="andrew">Andrew</option>
                    </select>
                    <div class="user-avatar">
                        <span id="userInitials">E</span>
                    </div>
                    <div class="user-info">
                        <span id="userName">Esteban</span>
                        <small>Fleet Manager</small>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- Dashboard Tab -->
                <div class="tab-content active" id="dashboard">
                    <h1 class="section-title">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </h1>

                    <div class="dashboard-cards">
                        <div class="card stat-card">
                            <h3>Total Vehicles</h3>
                            <div class="value" id="totalVehiclesStat">0</div>
                            <div class="change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+2 since last month</span>
                            </div>
                        </div>

                        <div class="card stat-card">
                            <h3>Active Trips</h3>
                            <div class="value" id="activeTripsStat">0</div>
                            <div class="change negative">
                                <i class="fas fa-arrow-down"></i>
                                <span>-3 from yesterday</span>
                            </div>
                        </div>

                        <div class="card stat-card">
                            <h3>Maintenance Due</h3>
                            <div class="value" id="maintenanceDueStat">0</div>
                            <div class="change positive">
                                <i class="fas fa-arrow-down"></i>
                                <span>-2 from last week</span>
                            </div>
                        </div>

                        <div class="card stat-card">
                            <h3>Fuel Efficiency</h3>
                            <div class="value" id="fuelEfficiencyStat">0</div>
                            <div class="change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+0.4 mpg improvement</span>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 20px;">
                        <h2 class="section-title">
                            <i class="fas fa-gas-pump"></i>
                            Fuel Efficiency Trend
                        </h2>
                        <div class="chart-container">
                            <canvas id="fuelEfficiencyChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="section-title">
                            <i class="fas fa-route"></i>
                            Active Routes
                        </h2>

                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Route ID</th>
                                        <th>Driver</th>
                                        <th>Vehicle</th>
                                        <th>Destination</th>
                                        <th>Status</th>
                                        <th>ETA</th>
                                    </tr>
                                </thead>
                                <tbody id="activeRoutesTableBody">
                                    <!-- Active routes will be dynamically inserted here from Firestore -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h2 class="section-title">
                            <i class="fas fa-tools"></i>
                            Upcoming Maintenance
                        </h2>
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Vehicle</th>
                                        <th>Service Type</th>
                                        <th>Due Date</th>
                                        <th>Odometer</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="upcomingMaintenanceTableBody">
                                    <!-- Upcoming maintenance will be dynamically inserted here from Firestore -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h2 class="section-title">
                            <i class="fas fa-car-crash"></i>
                            Active Breakdowns
                        </h2>
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Case ID</th>
                                        <th>Truck #</th>
                                        <th>Driver</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="activeBreakdownsTableBody">
                                    <!-- Active breakdowns will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vehicles Tab -->
                <div class="tab-content" id="vehicles">
                    <h1 class="section-title">
                        <i class="fas fa-truck"></i>
                        Vehicle Management
                    </h1>

                    <div class="action-bar" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div class="search-bar" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="vehicleSearchInput" placeholder="Search vehicles...">
                        </div>
                        <button class="btn btn-primary" id="addVehicleBtn">
                            <i class="fas fa-plus"></i>
                            Add Vehicle
                        </button>
                    </div>

                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Make/Model</th>
                                    <th>Year</th>
                                    <th>License Plate</th>
                                    <th>Odometer</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTableBody">
                                <!-- Vehicle rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Drivers Tab -->
                <div class="tab-content" id="drivers">
                    <h1 class="section-title">
                        <i class="fas fa-user"></i>
                        Driver Management
                    </h1>

                    <div class="action-bar" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div class="search-bar" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="driverSearchInput" placeholder="Search drivers...">
                        </div>
                        <button class="btn btn-primary" id="addDriverBtn">
                            <i class="fas fa-plus"></i>
                            Add Driver
                        </button>
                    </div>

                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>License #</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="driversTableBody">
                                <!-- Driver rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Maintenance Tab -->
                <div class="tab-content" id="maintenance">
                    <h1 class="section-title">
                        <i class="fas fa-tools"></i>
                        Maintenance Scheduling
                    </h1>

                    <div class="action-bar" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div class="search-bar" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="maintenanceSearchInput" placeholder="Search maintenance records...">
                        </div>
                        <button class="btn btn-primary" id="addMaintenanceBtn">
                            <i class="fas fa-plus"></i>
                            Add Maintenance Record
                        </button>
                    </div>

                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Record ID</th>
                                    <th>Vehicle</th>
                                    <th>Service Type</th>
                                    <th>Date</th>
                                    <th>Odometer</th>
                                    <th>Cost</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <!-- Maintenance records will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Breakdowns Tab -->
                <div class="tab-content" id="breakdowns">
                    <h1 class="section-title">
                        <i class="fas fa-car-crash"></i>
                        Breakdown Management
                    </h1>

                    <div class="action-bar" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div class="search-bar" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="breakdownSearchInput" placeholder="Search breakdown cases...">
                        </div>
                        <button class="btn btn-primary" id="addBreakdownBtn">
                            <i class="fas fa-plus"></i>
                            Report Breakdown
                        </button>
                    </div>

                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Case ID</th>
                                    <th>Truck #</th>
                                    <th>Trailer #</th>
                                    <th>Driver</th>
                                    <th>Agent</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="breakdownsTableBody">
                                <!-- Breakdown cases will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Routes Tab -->
                <div class="tab-content" id="routes">
                    <h1 class="section-title">
                        <i class="fas fa-route"></i>
                        Route Planning
                    </h1>

                    <div class="action-bar" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div class="search-bar" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="routeSearchInput" placeholder="Search routes...">
                        </div>
                        <button class="btn btn-primary" id="addRouteBtn">
                            <i class="fas fa-plus"></i>
                            Add Route
                        </button>
                    </div>

                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Route ID</th>
                                    <th>Vehicle</th>
                                    <th>Driver</th>
                                    <th>Origin</th>
                                    <th>Destination</th>
                                    <th>Scheduled Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="routesTableBody">
                                <!-- Route rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content" id="reports">
                    <h1 class="section-title">
                        <i class="fas fa-chart-bar"></i>
                        Reports & Analytics
                    </h1>
                    <p>Reports and analytics content would go here.</p>
                </div>

                <div class="tab-content" id="settings">
                    <h1 class="section-title">
                        <i class="fas fa-cog"></i>
                        System Settings
                    </h1>

                    <!-- User Preferences -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h2 class="section-title" style="font-size: 1.2rem; margin-bottom: 15px;">
                            <i class="fas fa-user"></i>
                            User Preferences
                        </h2>
                        <form id="userPreferencesForm">
                            <div class="form-group">
                                <label for="themeToggle">Theme</label>
                                <select id="themeToggle" name="theme">
                                    <option value="light">Light Mode</option>
                                    <option value="dark">Dark Mode</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notificationsEnabled">Enable Notifications</label>
                                <input type="checkbox" id="notificationsEnabled" name="notificationsEnabled">
                            </div>
                            <div class="form-group">
                                <label for="defaultUser">Default User</label>
                                <select id="defaultUser" name="defaultUser">
                                    <option value="esteban">Esteban</option>
                                    <option value="albert">Albert</option>
                                    <option value="andrew">Andrew</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </form>
                    </div>

                    <!-- System Settings -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h2 class="section-title" style="font-size: 1.2rem; margin-bottom: 15px;">
                            <i class="fas fa-cogs"></i>
                            System Settings
                        </h2>
                        <form id="systemSettingsForm">
                            <div class="form-group">
                                <label for="units">Units</label>
                                <select id="units" name="units">
                                    <option value="miles">Miles</option>
                                    <option value="km">Kilometers</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="currency">Currency</label>
                                <select id="currency" name="currency">
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR (€)</option>
                                    <option value="GBP">GBP (£)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dateFormat">Date Format</label>
                                <select id="dateFormat" name="dateFormat">
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="breakdownIssues">Breakdown Issues (one per line)</label>
                                <textarea id="breakdownIssues" name="breakdownIssues" rows="6"
                                    placeholder="Enter predefined breakdown issues, one per line"></textarea>
                                <div id="breakdownIssuesList" style="margin-top: 10px;"></div>
                                <button type="button" id="addBreakdownIssueBtn" class="btn btn-secondary"
                                    style="margin-top: 10px;">Add Issue</button>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>

                    <!-- Account Settings -->
                    <div class="card">
                        <h2 class="section-title" style="font-size: 1.2rem; margin-bottom: 15px;">
                            <i class="fas fa-user-circle"></i>
                            Account Settings
                        </h2>
                        <form id="accountSettingsForm">
                            <div class="form-group">
                                <label for="currentUserName">Current User Name</label>
                                <input type="text" id="currentUserName" name="currentUserName" readonly>
                            </div>
                            <div class="form-group">
                                <label for="newUserName">New User Name</label>
                                <input type="text" id="newUserName" name="newUserName"
                                    placeholder="Enter new user name">
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" name="newPassword"
                                    placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword"
                                    placeholder="Confirm new password">
                            </div>
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Vehicle Modal -->
    <div class="modal" id="vehicleModal">
        <div class="modal-content">
            <div class="loading-overlay" id="modalLoadingOverlay">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h2 id="vehicleModalTitle">Add New Vehicle</h2>
                <span class="close-modal" data-modal-id="vehicleModal">&times;</span>
            </div>
            <form id="vehicleForm">
                <input type="hidden" id="vehicleDocId" name="docId"> <!-- Firestore Document ID -->
                <div class="form-group">
                    <label for="vehicleId">Vehicle ID</label>
                    <input type="text" id="vehicleId" name="vehicleId" required minlength="3" maxlength="10"
                        pattern="[A-Z0-9-]+" title="e.g., TRK-123 or VAN-456">
                    <div class="error-message" id="vehicleIdError"></div>
                </div>
                <div class="form-group">
                    <label for="make">Make</label>
                    <input type="text" id="make" name="make" required minlength="2">
                    <div class="error-message" id="makeError"></div>
                </div>
                <div class="form-group">
                    <label for="model">Model</label>
                    <input type="text" id="model" name="model" required minlength="2">
                    <div class="error-message" id="modelError"></div>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <input type="number" id="year" name="year" min="1900" max="2099" required>
                    <div class="error-message" id="yearError"></div>
                </div>
                <div class="form-group">
                    <label for="license">License Plate</label>
                    <input type="text" id="license" name="license" required pattern="[A-Z0-9-]{5,10}"
                        title="e.g., PA-123AB or ABC-1234">
                    <div class="error-message" id="licenseError"></div>
                </div>
                <div class="form-group">
                    <label for="vin">VIN (Optional)</label>
                    <input type="text" id="vin" name="vin" minlength="17" maxlength="17" pattern="[A-HJ-NPR-Z0-9]{17}"
                        title="17 alphanumeric characters (excluding I, O, Q)">
                    <div class="error-message" id="vinError"></div>
                </div>
                <div class="form-group">
                    <label for="odometer">Current Odometer (miles)</label>
                    <input type="number" id="odometer" name="odometer" min="0" required>
                    <div class="error-message" id="odometerError"></div>
                </div>
                <div class="form-group" id="vehicleStatusGroup" style="display: none;">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="active">Active</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-id="vehicleModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveVehicleBtn">
                        <span id="saveVehicleBtnText">Save Vehicle</span>
                        <i class="fas fa-spinner fa-spin" style="display: none;" id="saveVehicleSpinner"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Driver Modal -->
    <div class="modal" id="driverModal">
        <div class="modal-content">
            <div class="loading-overlay" id="driverModalLoadingOverlay">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h2 id="driverModalTitle">Add New Driver</h2>
                <span class="close-modal" data-modal-id="driverModal">&times;</span>
            </div>
            <form id="driverForm">
                <input type="hidden" id="driverDocId" name="docId">
                <div class="form-group">
                    <label for="driverId">Driver ID</label>
                    <input type="text" id="driverId" name="driverId" required minlength="3" maxlength="10"
                        pattern="[A-Z0-9-]+" title="e.g., DRV-001">
                    <div class="error-message" id="driverIdError"></div>
                </div>
                <div class="form-group">
                    <label for="driverName">Full Name</label>
                    <input type="text" id="driverName" name="driverName" required minlength="3">
                    <div class="error-message" id="driverNameError"></div>
                </div>
                <div class="form-group">
                    <label for="driverLicense">License Number</label>
                    <input type="text" id="driverLicense" name="driverLicense" required pattern="[A-Z0-9-]{5,15}"
                        title="e.g., CDL-12345">
                    <div class="error-message" id="driverLicenseError"></div>
                </div>
                <div class="form-group">
                    <label for="driverPhone">Phone Number</label>
                    <input type="tel" id="driverPhone" name="driverPhone" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}"
                        placeholder="e.g., 123-456-7890">
                    <div class="error-message" id="driverPhoneError"></div>
                </div>
                <div class="form-group">
                    <label for="driverStatus">Status</label>
                    <select id="driverStatus" name="driverStatus">
                        <option value="active">Active</option>
                        <option value="on-leave">On Leave</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-id="driverModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveDriverBtn">
                        <span id="saveDriverBtnText">Save Driver</span>
                        <i class="fas fa-spinner fa-spin" style="display: none;" id="saveDriverSpinner"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Maintenance Modal -->
    <div class="modal" id="maintenanceModal">
        <div class="modal-content">
            <div class="loading-overlay" id="maintenanceModalLoadingOverlay">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h2 id="maintenanceModalTitle">Add New Maintenance Record</h2>
                <span class="close-modal" data-modal-id="maintenanceModal">&times;</span>
            </div>
            <form id="maintenanceForm">
                <input type="hidden" id="maintenanceDocId" name="docId">
                <div class="form-group">
                    <label for="maintenanceVehicleId">Vehicle</label>
                    <select id="maintenanceVehicleId" name="vehicleId" required>
                        <option value="">Select a Vehicle</option>
                        <!-- Options will be dynamically loaded -->
                    </select>
                    <div class="error-message" id="maintenanceVehicleIdError"></div>
                </div>
                <div class="form-group">
                    <label for="maintenanceServiceType">Service Type</label>
                    <input type="text" id="maintenanceServiceType" name="serviceType" required minlength="3">
                    <div class="error-message" id="maintenanceServiceTypeError"></div>
                </div>
                <div class="form-group">
                    <label for="maintenanceDate">Date</label>
                    <input type="date" id="maintenanceDate" name="date" required>
                    <div class="error-message" id="maintenanceDateError"></div>
                </div>
                <div class="form-group">
                    <label for="maintenanceOdometer">Odometer (miles)</label>
                    <input type="number" id="maintenanceOdometer" name="odometer" min="0" required>
                    <div class="error-message" id="maintenanceOdometerError"></div>
                </div>
                <div class="form-group">
                    <label for="maintenanceCost">Cost ($)</label>
                    <input type="number" id="maintenanceCost" name="cost" min="0" step="0.01" required>
                    <div class="error-message" id="maintenanceCostError"></div>
                </div>
                <div class="form-group">
                    <label for="maintenanceStatus">Status</label>
                    <select id="maintenanceStatus" name="status">
                        <option value="scheduled">Scheduled</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="maintenanceNotes">Notes</label>
                    <textarea id="maintenanceNotes" name="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-id="maintenanceModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveMaintenanceBtn">
                        <span id="saveMaintenanceBtnText">Save Record</span>
                        <i class="fas fa-spinner fa-spin" style="display: none;" id="saveMaintenanceSpinner"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Breakdown Modal -->
    <div class="modal" id="breakdownModal">
        <div class="modal-content">
            <div class="loading-overlay" id="breakdownModalLoadingOverlay">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h2 id="breakdownModalTitle">Report New Breakdown</h2>
                <span class="close-modal" data-modal-id="breakdownModal">&times;</span>
            </div>
            <form id="breakdownForm">
                <input type="hidden" id="breakdownDocId" name="docId">

                <div class="form-group">
                    <label for="breakdownTruckNumber">Truck #</label>
                    <input type="text" id="breakdownTruckNumber" name="truckNumber" required>
                    <div class="error-message" id="breakdownTruckNumberError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownTrailerNumber">Trailer #</label>
                    <input type="text" id="breakdownTrailerNumber" name="trailerNumber">
                    <div class="error-message" id="breakdownTrailerNumberError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownDriverName">Driver Name</label>
                    <input type="text" id="breakdownDriverName" name="driverName" required>
                    <div class="error-message" id="breakdownDriverNameError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownAgentName">Agent Working Case</label>
                    <input type="text" id="breakdownAgentName" name="agentName" required>
                    <div class="error-message" id="breakdownAgentNameError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownMakeModel">Make/Model</label>
                    <input type="text" id="breakdownMakeModel" name="makeModel" required>
                    <div class="error-message" id="breakdownMakeModelError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownStoreName">Store Name</label>
                    <input type="text" id="breakdownStoreName" name="storeName">
                    <div class="error-message" id="breakdownStoreNameError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownLocation">Location</label>
                    <input type="text" id="breakdownLocation" name="location" required>
                    <div class="error-message" id="breakdownLocationError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownDescription">Description of Breakdown</label>
                    <textarea id="breakdownDescription" name="description" rows="3" required></textarea>
                    <div class="error-message" id="breakdownDescriptionError"></div>
                </div>
                <div class="form-group">
                    <label for="breakdownStatus">Status</label>
                    <select id="breakdownStatus" name="status">
                        <option value="reported">Reported</option>
                        <option value="in-progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Invoices (PDF only)</label>
                    <div class="file-upload-container" id="invoiceUploadContainer">
                        <input type="file" id="invoiceUpload" accept="application/pdf" multiple>
                        <p><i class="fas fa-cloud-upload-alt"></i> Drag & drop invoices here or click to upload</p>
                    </div>
                    <div class="file-preview-container" id="invoicePreviewContainer"></div>
                </div>

                <div class="form-group">
                    <label>Pictures (Images only)</label>
                    <div class="file-upload-container" id="pictureUploadContainer">
                        <input type="file" id="pictureUpload" accept="image/*" multiple>
                        <p><i class="fas fa-cloud-upload-alt"></i> Drag & drop pictures here or click to upload</p>
                    </div>
                    <div class="file-preview-container" id="picturePreviewContainer"></div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-id="breakdownModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBreakdownBtn">
                        <span id="saveBreakdownBtnText">Save Breakdown</span>
                        <i class="fas fa-spinner fa-spin" style="display: none;" id="saveBreakdownSpinner"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Route Modal -->
    <div class="modal" id="routeModal">
        <div class="modal-content">
            <div class="loading-overlay" id="routeModalLoadingOverlay">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h2 id="routeModalTitle">Add New Route</h2>
                <span class="close-modal" data-modal-id="routeModal">&times;</span>
            </div>
            <form id="routeForm">
                <input type="hidden" id="routeDocId" name="docId">
                <div class="form-group">
                    <label for="routeId">Route ID</label>
                    <input type="text" id="routeId" name="routeId" required minlength="3" maxlength="10"
                        pattern="[A-Z0-9-]+" title="e.g., RT-001">
                    <div class="error-message" id="routeIdError"></div>
                </div>
                <div class="form-group">
                    <label for="routeVehicleId">Vehicle</label>
                    <select id="routeVehicleId" name="vehicleId" required>
                        <option value="">Select a Vehicle</option>
                        <!-- Options will be dynamically loaded -->
                    </select>
                    <div class="error-message" id="routeVehicleIdError"></div>
                </div>
                <div class="form-group">
                    <label for="routeDriverId">Driver</label>
                    <select id="routeDriverId" name="driverId" required>
                        <option value="">Select a Driver</option>
                        <!-- Options will be dynamically loaded -->
                    </select>
                    <div class="error-message" id="routeDriverIdError"></div>
                </div>
                <div class="form-group">
                    <label for="routeOrigin">Origin</label>
                    <input type="text" id="routeOrigin" name="origin" required minlength="3">
                    <div class="error-message" id="routeOriginError"></div>
                </div>
                <div class="form-group">
                    <label for="routeDestination">Destination</label>
                    <input type="text" id="routeDestination" name="destination" required minlength="3">
                    <div class="error-message" id="routeDestinationError"></div>
                </div>
                <div class="form-group">
                    <label for="routeScheduledDate">Scheduled Date</label>
                    <input type="date" id="routeScheduledDate" name="scheduledDate" required>
                    <div class="error-message" id="routeScheduledDateError"></div>
                </div>
                <div class="form-group">
                    <label for="routeStatus">Status</label>
                    <select id="routeStatus" name="status">
                        <option value="scheduled">Scheduled</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="routeNotes">Notes</label>
                    <textarea id="routeNotes" name="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal-id="routeModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveRouteBtn">
                        <span id="saveRouteBtnText">Save Route</span>
                        <i class="fas fa-spinner fa-spin" style="display: none;" id="saveRouteSpinner"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-content">
            <h3 id="confirmationTitle">Confirm Action</h3>
            <p id="confirmationMessage">Are you sure you want to proceed?</p>
            <div class="confirmation-buttons">
                <button class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // --- Back4App Parse Configuration ---
        // Parse Classes
        const Vehicle = Parse.Object.extend('Vehicle');
        const Driver = Parse.Object.extend('Driver');
        const Route = Parse.Object.extend('Route');
        const Breakdown = Parse.Object.extend('Breakdown');
        const Maintenance = Parse.Object.extend('Maintenance');

        // --- Local Storage Configuration (only for settings) ---
        const STORAGE_KEYS = {
            settings: 'erp_settings'
        };

        // --- Global Data ---
        let vehicles = [];
        let breakdowns = [];
        let drivers = [];
        let maintenanceRecords = [];
        let routes = [];
        let settings = {}; // Settings object

        // Real-time listeners
        let vehiclesUnsubscribe, driversUnsubscribe, routesUnsubscribe, breakdownsUnsubscribe, maintenanceUnsubscribe;

        // --- Local Storage Helper Functions (for settings only) ---
        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.error(`Error loading from localStorage for ${key}:`, error);
                return {};
            }
        }

        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`Error saving to localStorage for ${key}:`, error);
            }
        }

        // Setup real-time listeners using Parse Live Queries
        function setupRealtimeListeners() {
            // Vehicles listener
            const vehiclesQuery = new Parse.Query(Vehicle);
            vehiclesUnsubscribe = vehiclesQuery.subscribe();
            vehiclesUnsubscribe.on('create', (vehicle) => {
                vehicles.push({ id: vehicle.id, ...vehicle.attributes });
                renderVehiclesTable(vehicles);
                updateDashboardStats();
                populateMaintenanceVehicleSelect();
                populateRouteVehicleSelect();
            });
            vehiclesUnsubscribe.on('update', (vehicle) => {
                const index = vehicles.findIndex(v => v.id === vehicle.id);
                if (index !== -1) {
                    vehicles[index] = { id: vehicle.id, ...vehicle.attributes };
                }
                renderVehiclesTable(vehicles);
                updateDashboardStats();
                populateMaintenanceVehicleSelect();
                populateRouteVehicleSelect();
            });
            vehiclesUnsubscribe.on('delete', (vehicle) => {
                vehicles = vehicles.filter(v => v.id !== vehicle.id);
                renderVehiclesTable(vehicles);
                updateDashboardStats();
                populateMaintenanceVehicleSelect();
                populateRouteVehicleSelect();
            });

            // Drivers listener
            const driversQuery = new Parse.Query(Driver);
            driversUnsubscribe = driversQuery.subscribe();
            driversUnsubscribe.on('create', (driver) => {
                drivers.push({ id: driver.id, ...driver.attributes });
                renderDriversTable(drivers);
                populateRouteDriverSelect();
            });
            driversUnsubscribe.on('update', (driver) => {
                const index = drivers.findIndex(d => d.id === driver.id);
                if (index !== -1) {
                    drivers[index] = { id: driver.id, ...driver.attributes };
                }
                renderDriversTable(drivers);
                populateRouteDriverSelect();
            });
            driversUnsubscribe.on('delete', (driver) => {
                drivers = drivers.filter(d => d.id !== driver.id);
                renderDriversTable(drivers);
                populateRouteDriverSelect();
            });

            // Routes listener
            const routesQuery = new Parse.Query(Route);
            routesUnsubscribe = routesQuery.subscribe();
            routesUnsubscribe.on('create', (route) => {
                routes.push({ id: route.id, ...route.attributes });
                renderRoutesTable(routes);
                renderDashboardActiveRoutes();
                updateDashboardStats();
            });
            routesUnsubscribe.on('update', (route) => {
                const index = routes.findIndex(r => r.id === route.id);
                if (index !== -1) {
                    routes[index] = { id: route.id, ...route.attributes };
                }
                renderRoutesTable(routes);
                renderDashboardActiveRoutes();
                updateDashboardStats();
            });
            routesUnsubscribe.on('delete', (route) => {
                routes = routes.filter(r => r.id !== route.id);
                renderRoutesTable(routes);
                renderDashboardActiveRoutes();
                updateDashboardStats();
            });

            // Breakdowns listener
            const breakdownsQuery = new Parse.Query(Breakdown);
            breakdownsUnsubscribe = breakdownsQuery.subscribe();
            breakdownsUnsubscribe.on('create', (breakdown) => {
                breakdowns.push({ id: breakdown.id, ...breakdown.attributes });
                renderBreakdownsTable(breakdowns);
                renderDashboardActiveBreakdowns();
            });
            breakdownsUnsubscribe.on('update', (breakdown) => {
                const index = breakdowns.findIndex(b => b.id === breakdown.id);
                if (index !== -1) {
                    breakdowns[index] = { id: breakdown.id, ...breakdown.attributes };
                }
                renderBreakdownsTable(breakdowns);
                renderDashboardActiveBreakdowns();
            });
            breakdownsUnsubscribe.on('delete', (breakdown) => {
                breakdowns = breakdowns.filter(b => b.id !== breakdown.id);
                renderBreakdownsTable(breakdowns);
                renderDashboardActiveBreakdowns();
            });

            // Maintenance listener
            const maintenanceQuery = new Parse.Query(Maintenance);
            maintenanceUnsubscribe = maintenanceQuery.subscribe();
            maintenanceUnsubscribe.on('create', (maintenance) => {
                maintenanceRecords.push({ id: maintenance.id, ...maintenance.attributes });
                renderMaintenanceTable(maintenanceRecords);
                renderUpcomingMaintenance();
                updateDashboardStats();
            });
            maintenanceUnsubscribe.on('update', (maintenance) => {
                const index = maintenanceRecords.findIndex(m => m.id === maintenance.id);
                if (index !== -1) {
                    maintenanceRecords[index] = { id: maintenance.id, ...maintenance.attributes };
                }
                renderMaintenanceTable(maintenanceRecords);
                renderUpcomingMaintenance();
                updateDashboardStats();
            });
            maintenanceUnsubscribe.on('delete', (maintenance) => {
                maintenanceRecords = maintenanceRecords.filter(m => m.id !== maintenance.id);
                renderMaintenanceTable(maintenanceRecords);
                renderUpcomingMaintenance();
                updateDashboardStats();
            });
        }

        // Cleanup listeners
        function cleanupListeners() {
            if (vehiclesUnsubscribe) vehiclesUnsubscribe();
            if (driversUnsubscribe) driversUnsubscribe();
            if (routesUnsubscribe) routesUnsubscribe();
            if (breakdownsUnsubscribe) breakdownsUnsubscribe();
            if (maintenanceUnsubscribe) maintenanceUnsubscribe();
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        const fuelData = [
            { month: 'Jan', efficiency: 7.8 },
            { month: 'Feb', efficiency: 7.9 },
            { month: 'Mar', efficiency: 8.0 },
            { month: 'Apr', efficiency: 8.1 },
            { month: 'May', efficiency: 8.0 },
            { month: 'Jun', efficiency: 8.2 },
            { month: 'Jul', efficiency: 8.3 },
            { month: 'Aug', efficiency: 8.2 },
            { month: 'Sep', efficiency: 8.4 },
            { month: 'Oct', efficiency: 8.2 }
        ];

        // --- DOM Elements ---
        let menuItems = document.querySelectorAll('.menu-item');
        let tabContents = document.querySelectorAll('.tab-content');
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        const addVehicleBtn = document.getElementById('addVehicleBtn');
        const vehicleModal = document.getElementById('vehicleModal');
        const vehicleModalTitle = document.getElementById('vehicleModalTitle');
        const vehicleForm = document.getElementById('vehicleForm');
        const vehiclesTableBody = document.getElementById('vehiclesTableBody');
        const totalVehiclesStat = document.getElementById('totalVehiclesStat');
        const activeTripsStat = document.getElementById('activeTripsStat'); // Added for dynamic update
        const fuelEfficiencyStat = document.getElementById('fuelEfficiencyStat'); // Added for dynamic update
        const vehicleSearchInput = document.getElementById('vehicleSearchInput');
        const toastContainer = document.getElementById('toast-container');
        const modalLoadingOverlay = document.getElementById('modalLoadingOverlay'); // For vehicle modal
        const saveVehicleBtn = document.getElementById('saveVehicleBtn');
        const saveVehicleBtnText = document.getElementById('saveVehicleBtnText');
        const saveVehicleSpinner = document.getElementById('saveVehicleSpinner');
        const fuelEfficiencyChartCanvas = document.getElementById('fuelEfficiencyChart');
        const vehicleStatusGroup = document.getElementById('vehicleStatusGroup');
        const userSelector = document.getElementById('userSelector');
        const userName = document.getElementById('userName');
        const userInitials = document.getElementById('userInitials');

        // Breakdown DOM Elements
        const addBreakdownBtn = document.getElementById('addBreakdownBtn');
        const breakdownModal = document.getElementById('breakdownModal');
        const breakdownModalTitle = document.getElementById('breakdownModalTitle');
        const breakdownForm = document.getElementById('breakdownForm');
        const breakdownsTableBody = document.getElementById('breakdownsTableBody');
        const breakdownSearchInput = document.getElementById('breakdownSearchInput');
        const breakdownModalLoadingOverlay = document.getElementById('breakdownModalLoadingOverlay'); // For breakdown modal
        const saveBreakdownBtn = document.getElementById('saveBreakdownBtn');
        const saveBreakdownBtnText = document.getElementById('saveBreakdownBtnText');
        const saveBreakdownSpinner = document.getElementById('saveBreakdownSpinner');

        // Driver DOM Elements
        const addDriverBtn = document.getElementById('addDriverBtn');
        const driverModal = document.getElementById('driverModal');
        const driverModalTitle = document.getElementById('driverModalTitle');
        const driverForm = document.getElementById('driverForm');
        const driversTableBody = document.getElementById('driversTableBody');
        const driverSearchInput = document.getElementById('driverSearchInput');
        const driverModalLoadingOverlay = document.getElementById('driverModalLoadingOverlay');
        const saveDriverBtn = document.getElementById('saveDriverBtn');
        const saveDriverBtnText = document.getElementById('saveDriverBtnText');
        const saveDriverSpinner = document.getElementById('saveDriverSpinner');

        // Maintenance DOM Elements
        const addMaintenanceBtn = document.getElementById('addMaintenanceBtn');
        const maintenanceModal = document.getElementById('maintenanceModal');
        const maintenanceModalTitle = document.getElementById('maintenanceModalTitle');
        const maintenanceForm = document.getElementById('maintenanceForm');
        const maintenanceTableBody = document.getElementById('maintenanceTableBody');
        const maintenanceSearchInput = document.getElementById('maintenanceSearchInput');
        const maintenanceModalLoadingOverlay = document.getElementById('maintenanceModalLoadingOverlay');
        const saveMaintenanceBtn = document.getElementById('saveMaintenanceBtn');
        const saveMaintenanceBtnText = document.getElementById('saveMaintenanceBtnText');
        const saveMaintenanceSpinner = document.getElementById('saveMaintenanceSpinner');
        const maintenanceVehicleIdSelect = document.getElementById('maintenanceVehicleId');
        const upcomingMaintenanceTableBody = document.getElementById('upcomingMaintenanceTableBody');
        const maintenanceDueStat = document.getElementById('maintenanceDueStat');

        // Route DOM Elements
        const addRouteBtn = document.getElementById('addRouteBtn');
        const routeModal = document.getElementById('routeModal');
        const routeModalTitle = document.getElementById('routeModalTitle');
        const routeForm = document.getElementById('routeForm');
        const routesTableBody = document.getElementById('routesTableBody');
        const routeSearchInput = document.getElementById('routeSearchInput');
        const routeModalLoadingOverlay = document.getElementById('routeModalLoadingOverlay');
        const saveRouteBtn = document.getElementById('saveRouteBtn');
        const saveRouteBtnText = document.getElementById('saveRouteBtnText');
        const saveRouteSpinner = document.getElementById('saveRouteSpinner');
        const routeVehicleIdSelect = document.getElementById('routeVehicleId');
        const routeDriverIdSelect = document.getElementById('routeDriverId');
        const activeRoutesTableBody = document.getElementById('activeRoutesTableBody'); // Reference for dashboard table


        // File Upload Elements
        const invoiceUpload = document.getElementById('invoiceUpload');
        const invoicePreviewContainer = document.getElementById('invoicePreviewContainer');
        const pictureUpload = document.getElementById('pictureUpload');
        const picturePreviewContainer = document.getElementById('picturePreviewContainer');

        let uploadedInvoices = []; // Stores {file: File, url: string, name: string}
        let uploadedPictures = []; // Stores {file: File, url: string, name: string}


        // Confirmation Dialog Elements
        const confirmationDialog = document.getElementById('confirmationDialog');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');

        // --- Utility Functions ---

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warning'|'info'} type - The type of toast.
         * @param {number} duration - How long the toast should be visible in ms.
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            let icon = '';
            if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
            else if (type === 'error') icon = '<i class="fas fa-times-circle"></i>';
            else if (type === 'warning') icon = '<i class="fas fa-exclamation-triangle"></i>';
            else icon = '<i class="fas fa-info-circle"></i>';

            toast.innerHTML = `${icon} <span>${message}</span> <i class="fas fa-times close-toast"></i>`;
            toastContainer.appendChild(toast);

            // Allow manual dismissal
            toast.querySelector('.close-toast').addEventListener('click', () => {
                dismissToast(toast);
            });

            // Auto-dismiss after duration
            setTimeout(() => dismissToast(toast), duration);
        }

        function dismissToast(toastElement) {
            toastElement.style.animation = 'fadeOut 0.3s forwards';
            toastElement.addEventListener('animationend', () => {
                toastElement.remove();
            }, { once: true });
        }

        /**
         * Shows or hides a loading overlay.
         * @param {HTMLElement} overlayElement - The loading overlay element.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleLoadingOverlay(overlayElement, show) {
            overlayElement.style.display = show ? 'flex' : 'none';
        }

        /**
         * Shows or hides a button spinner.
         * @param {HTMLElement} button - The button element.
         * @param {HTMLElement} textSpan - The span containing the button text.
         * @param {HTMLElement} spinnerIcon - The spinner icon element.
         * @param {boolean} show - True to show spinner, false to hide.
         */
        function toggleButtonSpinner(button, textSpan, spinnerIcon, show) {
            if (show) {
                textSpan.style.display = 'none';
                spinnerIcon.style.display = 'inline-block';
                button.disabled = true;
            } else {
                textSpan.style.display = 'inline-block';
                spinnerIcon.style.display = 'none';
                button.disabled = false;
            }
        }

        /**
         * Shows a custom confirmation dialog.
         * @param {string} title - The title of the dialog.
         * @param {string} message - The message to display.
         * @returns {Promise<boolean>} Resolves true if confirmed, false if cancelled.
         */
        function showConfirmation(title, message) {
            return new Promise((resolve) => {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                confirmationDialog.style.display = 'flex';

                const onConfirm = () => {
                    confirmationDialog.style.display = 'none';
                    confirmActionBtn.removeEventListener('click', onConfirm);
                    cancelConfirmBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    confirmationDialog.style.display = 'none';
                    confirmActionBtn.removeEventListener('click', onConfirm);
                    cancelConfirmBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                confirmActionBtn.addEventListener('click', onConfirm);
                cancelConfirmBtn.addEventListener('click', onCancel);
            });
        }

        // Helper to get CSS variable value
        function getCssVariable(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(`--${name}`).trim();
        }

        // --- Tab Switching Logic ---
        function switchTab(tabId) {
            // Update active menu item
            menuItems.forEach(item => item.classList.remove('active'));
            const activeMenuItem = document.querySelector(`.menu-item[data-tab="${tabId}"]`);
            if (activeMenuItem) {
                activeMenuItem.classList.add('active');
            }

            // Show corresponding tab content
            tabContents.forEach(tab => tab.classList.remove('active'));
            const activeTabContent = document.getElementById(tabId);
            if (activeTabContent) {
                activeTabContent.classList.add('active');
            }

            // Special handling for dashboard to render chart and stats
            if (tabId === 'dashboard') {
                renderFuelEfficiencyChart();
                renderUpcomingMaintenance(); // Re-render upcoming maintenance on dashboard
                renderDashboardActiveRoutes(); // Render active routes on dashboard
                renderDashboardActiveBreakdowns(); // Render active breakdowns on dashboard
                updateDashboardStats(); // Update dashboard stats
            }
            // Special handling for maintenance tab to populate vehicle dropdown
            if (tabId === 'maintenance') {
                populateMaintenanceVehicleSelect();
            }
            // Special handling for routes tab to populate vehicle and driver dropdowns
            if (tabId === 'routes') {
                populateRouteVehicleSelect();
                populateRouteDriverSelect();
            }
        }

        // --- Menu Toggle Logic ---
        let sidebarVisible = true;
        menuToggle.addEventListener('click', () => {
            sidebarVisible = !sidebarVisible;
            if (sidebarVisible) {
                sidebar.classList.remove('hidden');
                menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                sidebar.classList.add('hidden');
                menuToggle.innerHTML = '<i class="fas fa-times"></i>';
            }
        });

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabId = item.getAttribute('data-tab');
                switchTab(tabId);
            });
        });

        // --- Vehicle Management (Firestore Integrated) ---

        /**
         * Renders the vehicles table with the given data.
         * @param {Array} vehiclesToRender - The array of vehicle objects to display.
         */
        function renderVehiclesTable(vehiclesToRender) {
            vehiclesTableBody.innerHTML = ''; // Clear existing rows
            if (vehiclesToRender.length === 0) {
                vehiclesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No vehicles found.</td></tr>';
                return;
            }

            vehiclesToRender.forEach(vehicle => {
                const row = vehiclesTableBody.insertRow();
                row.setAttribute('data-doc-id', vehicle.id); // Use Firestore document ID

                const statusSelectHtml = `
                    <select class="status-select ${vehicle.status}" data-doc-id="${vehicle.id}">
                        <option value="active" ${vehicle.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="maintenance" ${vehicle.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                        <option value="inactive" ${vehicle.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                    </select>
                `;

                row.innerHTML = `
                    <td>${vehicle.vehicleId || vehicle.id}</td>
                    <td>${vehicle.make} ${vehicle.model}</td>
                    <td>${vehicle.year}</td>
                    <td>${vehicle.license}</td>
                    <td>${vehicle.odometer.toLocaleString()} mi</td>
                    <td>${statusSelectHtml}</td>
                    <td class="action-buttons">
                        <i class="fas fa-eye action-btn" title="View Details" data-action="view"></i>
                        <i class="fas fa-edit action-btn" title="Edit Vehicle" data-action="edit"></i>
                        <i class="fas fa-trash action-btn" title="Delete Vehicle" data-action="delete"></i>
                    </td>
                `;
            });

            // Update dashboard stat
            totalVehiclesStat.textContent = vehicles.length;
        }

        // Handle vehicle table actions (View, Edit, Delete, Status Change) using event delegation
        vehiclesTableBody.addEventListener('click', handleVehicleTableActions);
        vehiclesTableBody.addEventListener('change', handleVehicleStatusChange);

        function handleVehicleTableActions(event) {
            const target = event.target;
            if (target.classList.contains('action-btn')) {
                const row = target.closest('tr');
                const docId = row.getAttribute('data-doc-id');
                const action = target.getAttribute('data-action');
                const vehicle = vehicles.find(v => v.id === docId);

                if (!vehicle) {
                    showToast('Vehicle not found!', 'error');
                    return;
                }

                switch (action) {
                    case 'view':
                        showToast(`Viewing details for ${vehicle.make} ${vehicle.model} (${vehicle.vehicleId || vehicle.id})`, 'info');
                        // In a real app, this would open a detailed view modal/page
                        break;
                    case 'edit':
                        openVehicleModalForEdit(vehicle);
                        break;
                    case 'delete':
                        deleteVehicle(docId, vehicle.vehicleId || vehicle.id);
                        break;
                }
            }
        }

        async function handleVehicleStatusChange(event) {
            const target = event.target;
            if (target.classList.contains('status-select')) {
                const objectId = target.getAttribute('data-doc-id');
                const newStatus = target.value;
                const vehicle = vehicles.find(v => v.id === objectId);
                const oldStatus = vehicle ? vehicle.status : newStatus;

                try {
                    const query = new Parse.Query(Vehicle);
                    const vehicleObj = await query.get(objectId);
                    vehicleObj.set('status', newStatus);
                    await vehicleObj.save();
                    showToast(`Vehicle status updated to ${newStatus}!`, 'success');
                } catch (error) {
                    console.error("Error updating vehicle status:", error);
                    showToast('Failed to update vehicle status: ' + error.message, 'error');
                    // Revert the select to previous value
                    if (vehicle) target.value = oldStatus;
                }
            }
        }

        async function deleteVehicle(objectId, vehicleIdDisplay) {
            const confirmed = await showConfirmation(
                'Delete Vehicle',
                `Are you sure you want to delete vehicle ${vehicleIdDisplay}? This action cannot be undone.`
            );

            if (confirmed) {
                try {
                    const query = new Parse.Query(Vehicle);
                    const vehicleObj = await query.get(objectId);
                    await vehicleObj.destroy();
                    showToast(`Vehicle ${vehicleIdDisplay} deleted successfully!`, 'success');
                } catch (error) {
                    console.error("Error deleting vehicle:", error);
                    showToast('Failed to delete vehicle: ' + error.message, 'error');
                }
            }
        }

        // Vehicle Search Functionality (client-side filtering of current 'vehicles' array)
        vehicleSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredVehicles = vehicles.filter(vehicle =>
                vehicle.id.toLowerCase().includes(searchTerm) ||
                vehicle.make.toLowerCase().includes(searchTerm) ||
                vehicle.model.toLowerCase().includes(searchTerm) ||
                vehicle.license.toLowerCase().includes(searchTerm)
            );
            renderVehiclesTable(filteredVehicles);
        });

        // --- Add/Edit Vehicle Modal Logic ---
        addVehicleBtn.addEventListener('click', () => {
            openVehicleModalForAdd();
        });

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (event) => {
                const modalId = event.target.dataset.modalId;
                document.getElementById(modalId).style.display = 'none';
            });
        });

        document.querySelectorAll('.form-actions .btn-secondary').forEach(btn => {
            btn.addEventListener('click', (event) => {
                const modalId = event.target.dataset.modalId;
                document.getElementById(modalId).style.display = 'none';
            });
        });

        // Close modal if clicked outside of modal content
        window.addEventListener('click', (event) => {
            if (event.target === vehicleModal) {
                vehicleModal.style.display = 'none';
            }
            if (event.target === breakdownModal) {
                breakdownModal.style.display = 'none';
            }
            if (event.target === driverModal) {
                driverModal.style.display = 'none';
            }
            if (event.target === maintenanceModal) { // Added for maintenance modal
                maintenanceModal.style.display = 'none';
            }
            if (event.target === routeModal) { // Added for route modal
                routeModal.style.display = 'none';
            }
            if (event.target === confirmationDialog) {
                confirmationDialog.style.display = 'none';
            }
        });

        function openVehicleModalForAdd() {
            vehicleForm.reset(); // Clear form fields
            clearFormErrors(vehicleForm); // Clear any previous errors
            document.getElementById('vehicleDocId').value = ''; // Clear hidden Firestore Doc ID
            document.getElementById('vehicleId').value = ''; // Clear vehicle ID for new entry
            document.getElementById('vehicleId').readOnly = false; // Make vehicle ID editable for new entry
            vehicleModalTitle.textContent = 'Add New Vehicle';
            vehicleStatusGroup.style.display = 'none'; // Hide status for new vehicle
            vehicleModal.style.display = 'flex';
        }

        function openVehicleModalForEdit(vehicle) {
            vehicleForm.reset();
            clearFormErrors(vehicleForm);
            vehicleModalTitle.textContent = `Edit Vehicle: ${vehicle.vehicleId || vehicle.id}`;
            document.getElementById('vehicleDocId').value = vehicle.id; // Set Firestore Doc ID
            document.getElementById('vehicleId').value = vehicle.vehicleId || vehicle.id; // Set vehicle ID
            document.getElementById('vehicleId').readOnly = true; // Make vehicle ID read-only for edit
            document.getElementById('make').value = vehicle.make;
            document.getElementById('model').value = vehicle.model;
            document.getElementById('year').value = vehicle.year;
            document.getElementById('license').value = vehicle.license;
            document.getElementById('vin').value = vehicle.vin || '';
            document.getElementById('odometer').value = vehicle.odometer;
            document.getElementById('status').value = vehicle.status;
            vehicleStatusGroup.style.display = 'block'; // Show status for existing vehicle
            vehicleModal.style.display = 'flex';
        }

        // Form Validation and Submission
        function validateFormInput(input) {
            const errorElement = document.getElementById(`${input.id}Error`);
            if (!errorElement) return true; // No specific error element, skip custom validation

            input.classList.remove('error');
            errorElement.textContent = '';

            if (input.validity.valid) {
                return true;
            } else {
                input.classList.add('error');
                if (input.validity.valueMissing) {
                    errorElement.textContent = 'This field is required.';
                } else if (input.validity.tooShort) {
                    errorElement.textContent = `Please enter at least ${input.minLength} characters.`;
                } else if (input.validity.tooLong) {
                    errorElement.textContent = `Please enter no more than ${input.maxLength} characters.`;
                } else if (input.validity.patternMismatch) {
                    errorElement.textContent = input.title || 'Please match the requested format.';
                } else if (input.validity.rangeUnderflow) {
                    errorElement.textContent = `Value must be at least ${input.min}.`;
                } else if (input.validity.rangeOverflow) {
                    errorElement.textContent = `Value must be at most ${input.max}.`;
                } else if (input.validity.typeMismatch && input.type === 'number') {
                    errorElement.textContent = 'Please enter a valid number.';
                }
                return false;
            }
        }

        function clearFormErrors(form) {
            form.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(input => {
                input.classList.remove('error');
                const errorElement = document.getElementById(`${input.id}Error`);
                if (errorElement) errorElement.textContent = '';
            });
        }

        vehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors(vehicleForm);

            let formIsValid = true;
            const formInputs = vehicleForm.querySelectorAll('input[required], select[required]');
            formInputs.forEach(input => {
                if (!validateFormInput(input)) {
                    formIsValid = false;
                }
            });

            if (!formIsValid) {
                showToast('Please correct the errors in the form.', 'error');
                return;
            }

            // Additional validation for VIN if provided
            const vinInput = document.getElementById('vin');
            if (vinInput.value && !validateFormInput(vinInput)) {
                showToast('Please correct the VIN format.', 'error');
                return;
            }

            const vehicleObjectId = document.getElementById('vehicleDocId').value;
            const vehicleData = {
                vehicleId: document.getElementById('vehicleId').value.toUpperCase(),
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                year: parseInt(document.getElementById('year').value),
                license: document.getElementById('license').value.toUpperCase(),
                vin: document.getElementById('vin').value ? document.getElementById('vin').value.toUpperCase() : '',
                odometer: parseInt(document.getElementById('odometer').value),
                status: document.getElementById('status').value || 'active',
                updatedAt: new Date().toISOString()
            };

            if (!vehicleObjectId) {
                vehicleData.createdAt = new Date().toISOString();
            }

            try {
                toggleButtonSpinner(saveVehicleBtn, saveVehicleBtnText, saveVehicleSpinner, true);

                if (vehicleObjectId) {
                    // Update existing vehicle
                    const query = new Parse.Query(Vehicle);
                    const vehicleObj = await query.get(vehicleObjectId);
                    vehicleObj.set(vehicleData);
                    await vehicleObj.save();
                    showToast(`Vehicle ${vehicleData.vehicleId} updated successfully!`, 'success');
                } else {
                    // Check for duplicate vehicleId
                    const query = new Parse.Query(Vehicle);
                    query.equalTo('vehicleId', vehicleData.vehicleId);
                    const results = await query.find();

                    if (results.length > 0) {
                        showToast(`Vehicle ID ${vehicleData.vehicleId} already exists. Please use a unique ID.`, 'error');
                        document.getElementById('vehicleId').classList.add('error');
                        document.getElementById('vehicleIdError').textContent = 'This Vehicle ID already exists.';
                        toggleButtonSpinner(saveVehicleBtn, saveVehicleBtnText, saveVehicleSpinner, false);
                        return;
                    }

                    // Add new vehicle
                    const vehicleObj = new Vehicle();
                    vehicleObj.set(vehicleData);
                    await vehicleObj.save();
                    showToast('Vehicle added successfully!', 'success');
                }

                vehicleModal.style.display = 'none';
                vehicleForm.reset();
            } catch (error) {
                console.error("Error saving vehicle:", error);
                showToast('Failed to save vehicle: ' + error.message, 'error');
            } finally {
                toggleButtonSpinner(saveVehicleBtn, saveVehicleBtnText, saveVehicleSpinner, false);
            }
        });

        // Add real-time validation on input blur
        vehicleForm.querySelectorAll('input[required], select[required]').forEach(input => {
            input.addEventListener('blur', () => validateFormInput(input));
            input.addEventListener('input', () => { // Clear error message as user types
                const errorElement = document.getElementById(`${input.id}Error`);
                if (errorElement && input.validity.valid) {
                    input.classList.remove('error');
                    errorElement.textContent = '';
                }
            });
        });

        // --- Driver Management (Firestore Integrated) ---

        /**
         * Renders the drivers table with the given data.
         * @param {Array} driversToRender - The array of driver objects to display.
         */
        function renderDriversTable(driversToRender) {
            driversTableBody.innerHTML = ''; // Clear existing rows
            if (driversToRender.length === 0) {
                driversTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No drivers found.</td></tr>';
                return;
            }

            driversToRender.forEach(driver => {
                const row = driversTableBody.insertRow();
                row.setAttribute('data-doc-id', driver.id);

                const statusClass = driver.status === 'active' ? 'active' :
                    driver.status === 'on-leave' ? 'maintenance' : 'inactive';

                const statusSelectHtml = `
                    <select class="status-select ${statusClass}" data-doc-id="${driver.id}">
                        <option value="active" ${driver.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="on-leave" ${driver.status === 'on-leave' ? 'selected' : ''}>On Leave</option>
                        <option value="inactive" ${driver.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                    </select>
                `;

                row.innerHTML = `
                    <td>${driver.driverId || driver.id}</td>
                    <td>${driver.name}</td>
                    <td>${driver.licenseNumber}</td>
                    <td>${driver.phoneNumber || 'N/A'}</td>
                    <td>${statusSelectHtml}</td>
                    <td class="action-buttons">
                        <i class="fas fa-edit action-btn" title="Edit Driver" data-action="edit"></i>
                        <i class="fas fa-trash action-btn" title="Delete Driver" data-action="delete"></i>
                    </td>
                `;
            });
        }

        // Handle driver table actions
        driversTableBody.addEventListener('click', handleDriverTableActions);
        driversTableBody.addEventListener('change', handleDriverStatusChange);

        function handleDriverTableActions(event) {
            const target = event.target;
            if (target.classList.contains('action-btn')) {
                const row = target.closest('tr');
                const docId = row.getAttribute('data-doc-id');
                const action = target.getAttribute('data-action');
                const driver = drivers.find(d => d.id === docId);

                if (!driver) {
                    showToast('Driver not found!', 'error');
                    return;
                }

                switch (action) {
                    case 'edit':
                        openDriverModalForEdit(driver);
                        break;
                    case 'delete':
                        deleteDriver(docId, driver.driverId || driver.id);
                        break;
                }
            }
        }

        async function handleDriverStatusChange(event) {
            const target = event.target;
            if (target.classList.contains('status-select')) {
                const objectId = target.getAttribute('data-doc-id');
                const newStatus = target.value;
                const driver = drivers.find(d => d.id === objectId);
                const oldStatus = driver ? driver.status : newStatus;

                try {
                    const query = new Parse.Query(Driver);
                    const driverObj = await query.get(objectId);
                    driverObj.set('status', newStatus);
                    await driverObj.save();
                    showToast(`Driver status updated to ${newStatus}!`, 'success');
                } catch (error) {
                    console.error("Error updating driver status:", error);
                    showToast('Failed to update driver status: ' + error.message, 'error');
                    if (driver) target.value = oldStatus;
                }
            }
        }


        async function deleteDriver(objectId, driverIdDisplay) {
            const confirmed = await showConfirmation(
                'Delete Driver',
                `Are you sure you want to delete driver ${driverIdDisplay}? This action cannot be undone.`
            );

            if (confirmed) {
                try {
                    const query = new Parse.Query(Driver);
                    const driverObj = await query.get(objectId);
                    await driverObj.destroy();
                    showToast(`Driver ${driverIdDisplay} deleted successfully!`, 'success');
                } catch (error) {
                    console.error("Error deleting driver:", error);
                    showToast('Failed to delete driver: ' + error.message, 'error');
                }
            }
        }

        // Driver Search Functionality
        driverSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredDrivers = drivers.filter(driver =>
                (driver.driverId || driver.id).toLowerCase().includes(searchTerm) ||
                driver.name.toLowerCase().includes(searchTerm) ||
                driver.licenseNumber.toLowerCase().includes(searchTerm) ||
                (driver.phoneNumber && driver.phoneNumber.toLowerCase().includes(searchTerm))
            );
            renderDriversTable(filteredDrivers);
        });

        // --- Add/Edit Driver Modal Logic ---
        addDriverBtn.addEventListener('click', () => {
            openDriverModalForAdd();
        });

        function openDriverModalForAdd() {
            driverForm.reset();
            clearFormErrors(driverForm);
            driverModalTitle.textContent = 'Add New Driver';
            document.getElementById('driverDocId').value = '';
            document.getElementById('driverId').value = '';
            document.getElementById('driverId').readOnly = false;
            document.getElementById('driverStatus').value = 'active'; // Default status
            driverModal.style.display = 'flex';
        }

        function openDriverModalForEdit(driver) {
            driverForm.reset();
            clearFormErrors(driverForm);
            driverModalTitle.textContent = `Edit Driver: ${driver.driverId || driver.id}`;
            document.getElementById('driverDocId').value = driver.id;
            document.getElementById('driverId').value = driver.driverId || driver.id;
            document.getElementById('driverId').readOnly = true; // Driver ID is read-only when editing
            document.getElementById('driverName').value = driver.name;
            document.getElementById('driverLicense').value = driver.licenseNumber;
            document.getElementById('driverPhone').value = driver.phoneNumber || '';
            document.getElementById('driverStatus').value = driver.status;
            driverModal.style.display = 'flex';
        }

        // Driver Form Validation and Submission
        driverForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors(driverForm);

            let formIsValid = true;
            const formInputs = driverForm.querySelectorAll('input[required], select[required]');
            formInputs.forEach(input => {
                if (!validateFormInput(input)) {
                    formIsValid = false;
                }
            });

            if (!formIsValid) {
                showToast('Please correct the errors in the form.', 'error');
                return;
            }

            toggleButtonSpinner(saveDriverBtn, saveDriverBtnText, saveDriverSpinner, true);
            toggleLoadingOverlay(driverModalLoadingOverlay, true);

            const driverObjectId = document.getElementById('driverDocId').value;
            const driverData = {
                driverId: document.getElementById('driverId').value.toUpperCase(),
                name: document.getElementById('driverName').value,
                licenseNumber: document.getElementById('driverLicense').value.toUpperCase(),
                phoneNumber: document.getElementById('driverPhone').value,
                status: document.getElementById('driverStatus').value || 'active',
                updatedAt: new Date().toISOString()
            };

            if (!driverObjectId) {
                driverData.createdAt = new Date().toISOString();
            }

            try {
                if (driverObjectId) {
                    const query = new Parse.Query(Driver);
                    const driverObj = await query.get(driverObjectId);
                    driverObj.set(driverData);
                    await driverObj.save();
                    showToast(`Driver ${driverData.driverId} updated successfully!`, 'success');
                } else {
                    const query = new Parse.Query(Driver);
                    query.equalTo('driverId', driverData.driverId);
                    const results = await query.find();

                    if (results.length > 0) {
                        showToast(`Driver ID ${driverData.driverId} already exists. Please use a unique ID.`, 'error');
                        document.getElementById('driverId').classList.add('error');
                        document.getElementById('driverIdError').textContent = 'This Driver ID already exists.';
                        toggleButtonSpinner(saveDriverBtn, saveDriverBtnText, saveDriverSpinner, false);
                        toggleLoadingOverlay(driverModalLoadingOverlay, false);
                        return;
                    }

                    const driverObj = new Driver();
                    driverObj.set(driverData);
                    await driverObj.save();
                    showToast('Driver added successfully!', 'success');
                }

                driverModal.style.display = 'none';
                driverForm.reset();
            } catch (error) {
                console.error("Error saving driver:", error);
                showToast('Failed to save driver: ' + error.message, 'error');
            } finally {
                toggleButtonSpinner(saveDriverBtn, saveDriverBtnText, saveDriverSpinner, false);
                toggleLoadingOverlay(driverModalLoadingOverlay, false);
            }
        });

        // Add real-time validation on input blur for driver form
        driverForm.querySelectorAll('input[required], select[required]').forEach(input => {
            input.addEventListener('blur', () => validateFormInput(input));
            input.addEventListener('input', () => {
                const errorElement = document.getElementById(`${input.id}Error`);
                if (errorElement && input.validity.valid) {
                    input.classList.remove('error');
                    errorElement.textContent = '';
                }
            });
        });

        // --- Maintenance Management (Firestore Integrated) ---

        /**
         * Populates the vehicle select dropdown in the maintenance modal.
         */
        function populateMaintenanceVehicleSelect() {
            maintenanceVehicleIdSelect.innerHTML = '<option value="">Select a Vehicle</option>';
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id; // Store Firestore doc ID as value
                option.textContent = `${vehicle.vehicleId || vehicle.id} - ${vehicle.make} ${vehicle.model}`;
                maintenanceVehicleIdSelect.appendChild(option);
            });
        }

        /**
         * Renders the maintenance table with the given data.
         * @param {Array} recordsToRender - The array of maintenance record objects to display.
         */
        function renderMaintenanceTable(recordsToRender) {
            maintenanceTableBody.innerHTML = ''; // Clear existing rows
            if (recordsToRender.length === 0) {
                maintenanceTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No maintenance records found.</td></tr>';
                return;
            }

            recordsToRender.forEach(record => {
                const row = maintenanceTableBody.insertRow();
                row.setAttribute('data-doc-id', record.id);

                const vehicle = vehicles.find(v => v.id === record.vehicleId);
                const vehicleDisplay = vehicle ? `${vehicle.vehicleId || vehicle.id} (${vehicle.make} ${vehicle.model})` : 'N/A';

                const statusClass = record.status === 'completed' ? 'active' :
                    record.status === 'scheduled' ? 'maintenance' :
                        record.status === 'in-progress' ? 'maintenance' : 'inactive';

                const statusSelectHtml = `
                    <select class="status-select ${statusClass}" data-doc-id="${record.id}">
                        <option value="scheduled" ${record.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                        <option value="in-progress" ${record.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${record.status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="cancelled" ${record.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                `;

                row.innerHTML = `
                    <td>${record.recordId}</td>
                    <td>${vehicleDisplay}</td>
                    <td>${record.serviceType}</td>
                    <td>${record.date}</td>
                    <td>${record.odometer.toLocaleString()} mi</td>
                    <td>$${record.cost.toFixed(2)}</td>
                    <td>${statusSelectHtml}</td>
                    <td class="action-buttons">
                        <i class="fas fa-edit action-btn" title="Edit Record" data-action="edit"></i>
                        <i class="fas fa-trash action-btn" title="Delete Record" data-action="delete"></i>
                    </td>
                `;
            });
        }

        // Handle maintenance table actions
        maintenanceTableBody.addEventListener('click', handleMaintenanceTableActions);
        maintenanceTableBody.addEventListener('change', handleMaintenanceStatusChange);

        function handleMaintenanceTableActions(event) {
            const target = event.target;
            if (target.classList.contains('action-btn')) {
                const row = target.closest('tr');
                const docId = row.getAttribute('data-doc-id');
                const action = target.getAttribute('data-action');
                const record = maintenanceRecords.find(r => r.id === docId);

                if (!record) {
                    showToast('Maintenance record not found!', 'error');
                    return;
                }

                switch (action) {
                    case 'edit':
                        openMaintenanceModalForEdit(record);
                        break;
                    case 'delete':
                        deleteMaintenanceRecord(docId, record.recordId);
                        break;
                }
            }
        }

        async function handleMaintenanceStatusChange(event) {
            const target = event.target;
            if (target.classList.contains('status-select')) {
                const objectId = target.getAttribute('data-doc-id');
                const newStatus = target.value;
                const record = maintenanceRecords.find(r => r.id === objectId);
                const oldStatus = record ? record.status : newStatus;

                try {
                    const query = new Parse.Query(Maintenance);
                    const maintenanceObj = await query.get(objectId);
                    maintenanceObj.set('status', newStatus);
                    await maintenanceObj.save();
                    showToast(`Maintenance status updated to ${newStatus}!`, 'success');
                } catch (error) {
                    console.error("Error updating maintenance status:", error);
                    showToast('Failed to update maintenance status: ' + error.message, 'error');
                    if (record) target.value = oldStatus;
                }
            }
        }

        async function deleteMaintenanceRecord(objectId, recordIdDisplay) {
            const confirmed = await showConfirmation(
                'Delete Maintenance Record',
                `Are you sure you want to delete maintenance record ${recordIdDisplay}? This action cannot be undone.`
            );

            if (confirmed) {
                try {
                    const query = new Parse.Query(Maintenance);
                    const maintenanceObj = await query.get(objectId);
                    await maintenanceObj.destroy();
                    showToast(`Maintenance record ${recordIdDisplay} deleted successfully!`, 'success');
                } catch (error) {
                    console.error("Error deleting maintenance record:", error);
                    showToast('Failed to delete maintenance record: ' + error.message, 'error');
                }
            }
        }

        // Maintenance Search Functionality
        maintenanceSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredRecords = maintenanceRecords.filter(record => {
                const vehicle = vehicles.find(v => v.id === record.vehicleId);
                const vehicleDisplay = vehicle ? `${vehicle.vehicleId || vehicle.id} ${vehicle.make} ${vehicle.model}` : '';
                return record.recordId.toLowerCase().includes(searchTerm) ||
                    vehicleDisplay.toLowerCase().includes(searchTerm) ||
                    record.serviceType.toLowerCase().includes(searchTerm) ||
                    record.status.toLowerCase().includes(searchTerm);
            });
            renderMaintenanceTable(filteredRecords);
        });

        // --- Add/Edit Maintenance Modal Logic ---
        addMaintenanceBtn.addEventListener('click', () => {
            openMaintenanceModalForAdd();
        });

        function openMaintenanceModalForAdd() {
            maintenanceForm.reset();
            clearFormErrors(maintenanceForm);
            maintenanceModalTitle.textContent = 'Add New Maintenance Record';
            document.getElementById('maintenanceDocId').value = '';
            document.getElementById('maintenanceStatus').value = 'scheduled'; // Default status
            populateMaintenanceVehicleSelect(); // Populate dropdown with current vehicles
            maintenanceModal.style.display = 'flex';
        }

        function openMaintenanceModalForEdit(record) {
            maintenanceForm.reset();
            clearFormErrors(maintenanceForm);
            maintenanceModalTitle.textContent = `Edit Maintenance Record: ${record.recordId}`;
            document.getElementById('maintenanceDocId').value = record.id;

            populateMaintenanceVehicleSelect(); // Populate dropdown first
            document.getElementById('maintenanceVehicleId').value = record.vehicleId;
            document.getElementById('maintenanceServiceType').value = record.serviceType;
            document.getElementById('maintenanceDate').value = record.date;
            document.getElementById('maintenanceOdometer').value = record.odometer;
            document.getElementById('maintenanceCost').value = record.cost;
            document.getElementById('maintenanceStatus').value = record.status;
            document.getElementById('maintenanceNotes').value = record.notes || '';

            maintenanceModal.style.display = 'flex';
        }

        // Maintenance Form Validation and Submission
        maintenanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors(maintenanceForm);

            let formIsValid = true;
            const formInputs = maintenanceForm.querySelectorAll('input[required], select[required], textarea[required]');
            formInputs.forEach(input => {
                if (!validateFormInput(input)) {
                    formIsValid = false;
                }
            });

            if (!formIsValid) {
                showToast('Please correct the errors in the form.', 'error');
                return;
            }

            toggleButtonSpinner(saveMaintenanceBtn, saveMaintenanceBtnText, saveMaintenanceSpinner, true);
            toggleLoadingOverlay(maintenanceModalLoadingOverlay, true);

            const maintenanceObjectId = document.getElementById('maintenanceDocId').value;
            const maintenanceData = {
                recordId: maintenanceObjectId ? maintenanceRecords.find(r => r.id === maintenanceObjectId).recordId : `MNT-${Math.floor(10000 + Math.random() * 90000)}`,
                vehicleId: document.getElementById('maintenanceVehicleId').value,
                serviceType: document.getElementById('maintenanceServiceType').value,
                date: document.getElementById('maintenanceDate').value,
                odometer: parseInt(document.getElementById('maintenanceOdometer').value),
                cost: parseFloat(document.getElementById('maintenanceCost').value),
                status: document.getElementById('maintenanceStatus').value,
                notes: document.getElementById('maintenanceNotes').value,
                updatedAt: new Date().toISOString()
            };

            if (!maintenanceObjectId) {
                maintenanceData.createdAt = new Date().toISOString();
            }

            try {
                if (maintenanceObjectId) {
                    const query = new Parse.Query(Maintenance);
                    const maintenanceObj = await query.get(maintenanceObjectId);
                    maintenanceObj.set(maintenanceData);
                    await maintenanceObj.save();
                    showToast(`Maintenance record ${maintenanceData.recordId} updated successfully!`, 'success');
                } else {
                    const query = new Parse.Query(Maintenance);
                    query.equalTo('recordId', maintenanceData.recordId);
                    const results = await query.find();

                    if (results.length > 0) {
                        showToast(`Maintenance Record ID ${maintenanceData.recordId} already exists. Please try again.`, 'error');
                        toggleButtonSpinner(saveMaintenanceBtn, saveMaintenanceBtnText, saveMaintenanceSpinner, false);
                        toggleLoadingOverlay(maintenanceModalLoadingOverlay, false);
                        return;
                    }

                    const maintenanceObj = new Maintenance();
                    maintenanceObj.set(maintenanceData);
                    await maintenanceObj.save();
                    showToast('Maintenance record added successfully!', 'success');
                }

                maintenanceModal.style.display = 'none';
                maintenanceForm.reset();
            } catch (error) {
                console.error("Error saving maintenance record:", error);
                showToast('Failed to save maintenance record: ' + error.message, 'error');
            } finally {
                toggleButtonSpinner(saveMaintenanceBtn, saveMaintenanceBtnText, saveMaintenanceSpinner, false);
                toggleLoadingOverlay(maintenanceModalLoadingOverlay, false);
            }
        });

        // Add real-time validation on input blur for maintenance form
        maintenanceForm.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
            input.addEventListener('blur', () => validateFormInput(input));
            input.addEventListener('input', () => {
                const errorElement = document.getElementById(`${input.id}Error`);
                if (errorElement && input.validity.valid) {
                    input.classList.remove('error');
                    errorElement.textContent = '';
                }
            });
        });


        // --- Breakdown Management (Firestore Integrated) ---

        /**
         * Renders the breakdowns table with the given data.
         * @param {Array} breakdownsToRender - The array of breakdown objects to display.
         */
        function renderBreakdownsTable(breakdownsToRender) {
            breakdownsTableBody.innerHTML = ''; // Clear existing rows
            if (breakdownsToRender.length === 0) {
                breakdownsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No breakdown cases found.</td></tr>';
                return;
            }

            breakdownsToRender.forEach(breakdown => {
                const row = breakdownsTableBody.insertRow();
                row.setAttribute('data-doc-id', breakdown.id);

                const statusClass = breakdown.status === 'reported' ? 'inactive' :
                    breakdown.status === 'in-progress' ? 'maintenance' :
                        breakdown.status === 'resolved' ? 'active' : 'inactive';

                const statusSelectHtml = `
                    <select class="status-select ${statusClass}" data-doc-id="${breakdown.id}">
                        <option value="reported" ${breakdown.status === 'reported' ? 'selected' : ''}>Reported</option>
                        <option value="in-progress" ${breakdown.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="resolved" ${breakdown.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                        <option value="closed" ${breakdown.status === 'closed' ? 'selected' : ''}>Closed</option>
                    </select>
                `;

                row.innerHTML = `
                    <td>${breakdown.caseId}</td>
                    <td>${breakdown.truckNumber}</td>
                    <td>${breakdown.trailerNumber || 'N/A'}</td>
                    <td>${breakdown.driverName}</td>
                    <td>${breakdown.agentName}</td>
                    <td>${breakdown.location}</td>
                    <td>${statusSelectHtml}</td>
                    <td class="action-buttons">
                        <i class="fas fa-eye action-btn" title="View Details" data-action="view"></i>
                        <i class="fas fa-edit action-btn" title="Edit Breakdown" data-action="edit"></i>
                        <i class="fas fa-trash action-btn" title="Delete Breakdown" data-action="delete"></i>
                    </td>
                `;
            });
        }

        // Handle breakdown table actions
        breakdownsTableBody.addEventListener('click', handleBreakdownTableActions);
        breakdownsTableBody.addEventListener('change', handleBreakdownStatusChange);

        function handleBreakdownTableActions(event) {
            const target = event.target;
            if (target.classList.contains('action-btn')) {
                const row = target.closest('tr');
                const docId = row.getAttribute('data-doc-id');
                const action = target.getAttribute('data-action');
                const breakdown = breakdowns.find(b => b.id === docId);

                if (!breakdown) {
                    showToast('Breakdown case not found!', 'error');
                    return;
                }

                switch (action) {
                    case 'view':
                        showToast(`Viewing details for Breakdown Case ${breakdown.caseId}`, 'info');
                        openBreakdownModalForEdit(breakdown, true); // Open in read-only mode
                        break;
                    case 'edit':
                        openBreakdownModalForEdit(breakdown);
                        break;
                    case 'delete':
                        deleteBreakdown(docId, breakdown.caseId);
                        break;
                }
            }
        }

        async function handleBreakdownStatusChange(event) {
            const target = event.target;
            if (target.classList.contains('status-select')) {
                const objectId = target.getAttribute('data-doc-id');
                const newStatus = target.value;
                const breakdown = breakdowns.find(b => b.id === objectId);
                const oldStatus = breakdown ? breakdown.status : newStatus;

                try {
                    const query = new Parse.Query(Breakdown);
                    const breakdownObj = await query.get(objectId);
                    breakdownObj.set('status', newStatus);
                    await breakdownObj.save();
                    showToast(`Breakdown status updated to ${newStatus}!`, 'success');
                } catch (error) {
                    console.error("Error updating breakdown status:", error);
                    showToast('Failed to update breakdown status: ' + error.message, 'error');
                    if (breakdown) target.value = oldStatus;
                }
            }
        }

        async function deleteBreakdown(objectId, caseIdDisplay) {
            const confirmed = await showConfirmation(
                'Delete Breakdown Case',
                `Are you sure you want to delete breakdown case ${caseIdDisplay}? This action cannot be undone.`
            );

            if (confirmed) {
                try {
                    // Optionally delete files from storage here if they are tied only to this breakdown
                    const breakdownToDelete = breakdowns.find(b => b.id === objectId);
                    if (breakdownToDelete && breakdownToDelete.invoices) {
                        for (const fileUrl of breakdownToDelete.invoices) {
                            try {
                                // For Back4App, file deletion is handled automatically or via Cloud Code
                                console.log('File deletion handled by Back4App:', fileUrl);
                            } catch (err) {
                                console.warn('Could not delete invoice file:', err);
                            }
                        }
                    }
                    if (breakdownToDelete && breakdownToDelete.pictures) {
                        for (const fileUrl of breakdownToDelete.pictures) {
                            try {
                                // For Back4App, file deletion is handled automatically or via Cloud Code
                                console.log('File deletion handled by Back4App:', fileUrl);
                            } catch (err) {
                                console.warn('Could not delete picture file:', err);
                            }
                        }
                    }

                    const query = new Parse.Query(Breakdown);
                    const breakdownObj = await query.get(objectId);
                    await breakdownObj.destroy();
                    showToast(`Breakdown case ${caseIdDisplay} deleted successfully!`, 'success');
                } catch (error) {
                    console.error("Error deleting breakdown:", error);
                    showToast('Failed to delete breakdown case: ' + error.message, 'error');
                }
            }
        }

        // Breakdown Search Functionality
        breakdownSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredBreakdowns = breakdowns.filter(breakdown =>
                breakdown.caseId.toLowerCase().includes(searchTerm) ||
                breakdown.truckNumber.toLowerCase().includes(searchTerm) ||
                (breakdown.trailerNumber && breakdown.trailerNumber.toLowerCase().includes(searchTerm)) ||
                breakdown.driverName.toLowerCase().includes(searchTerm) ||
                breakdown.agentName.toLowerCase().includes(searchTerm) ||
                breakdown.location.toLowerCase().includes(searchTerm) ||
                breakdown.makeModel.toLowerCase().includes(searchTerm) ||
                (breakdown.storeName && breakdown.storeName.toLowerCase().includes(searchTerm))
            );
            renderBreakdownsTable(filteredBreakdowns);
        });

        // --- Add/Edit Breakdown Modal Logic ---
        addBreakdownBtn.addEventListener('click', () => {
            openBreakdownModalForAdd();
        });

        function openBreakdownModalForAdd() {
            breakdownForm.reset();
            clearFormErrors(breakdownForm);
            breakdownModalTitle.textContent = 'Report New Breakdown';
            document.getElementById('breakdownDocId').value = '';
            document.getElementById('breakdownStatus').value = 'reported'; // Default status
            document.getElementById('breakdownStatus').disabled = false; // Enable status for editing

            uploadedInvoices = [];
            uploadedPictures = [];
            renderFilePreviews(invoicePreviewContainer, uploadedInvoices, 'invoice');
            renderFilePreviews(picturePreviewContainer, uploadedPictures, 'image');

            // Re-enable all form fields and show file upload containers/save button
            breakdownForm.querySelectorAll('input, textarea, select').forEach(input => {
                input.readOnly = false;
                input.disabled = false;
            });
            document.getElementById('invoiceUploadContainer').style.display = 'block';
            document.getElementById('pictureUploadContainer').style.display = 'block';
            saveBreakdownBtn.style.display = 'inline-flex';

            breakdownModal.style.display = 'flex';
        }

        function openBreakdownModalForEdit(breakdown, readOnly = false) {
            breakdownForm.reset();
            clearFormErrors(breakdownForm);
            breakdownModalTitle.textContent = readOnly ? `View Breakdown: ${breakdown.caseId}` : `Edit Breakdown: ${breakdown.caseId}`;
            document.getElementById('breakdownDocId').value = breakdown.id;

            document.getElementById('breakdownTruckNumber').value = breakdown.truckNumber;
            document.getElementById('breakdownTrailerNumber').value = breakdown.trailerNumber || '';
            document.getElementById('breakdownDriverName').value = breakdown.driverName;
            document.getElementById('breakdownAgentName').value = breakdown.agentName;
            document.getElementById('breakdownMakeModel').value = breakdown.makeModel;
            document.getElementById('breakdownStoreName').value = breakdown.storeName || '';
            document.getElementById('breakdownLocation').value = breakdown.location;
            document.getElementById('breakdownDescription').value = breakdown.description || '';
            document.getElementById('breakdownStatus').value = breakdown.status;

            // Populate uploaded files
            uploadedInvoices = breakdown.invoices ? breakdown.invoices.map(url => ({ url, name: getFileNameFromUrl(url), file: null })) : [];
            uploadedPictures = breakdown.pictures ? breakdown.pictures.map(url => ({ url, name: getFileNameFromUrl(url), file: null })) : [];

            // Store a copy of initial URLs for comparison on save
            breakdownForm.originalInvoiceUrls = [...(breakdown.invoices || [])];
            breakdownForm.originalPictureUrls = [...(breakdown.pictures || [])];

            renderFilePreviews(invoicePreviewContainer, uploadedInvoices, 'invoice');
            renderFilePreviews(picturePreviewContainer, uploadedPictures, 'image');

            // Set read-only state
            breakdownForm.querySelectorAll('input, textarea, select').forEach(input => {
                input.readOnly = readOnly;
                input.disabled = readOnly;
            });
            document.getElementById('breakdownStatus').disabled = readOnly;
            document.getElementById('invoiceUploadContainer').style.display = readOnly ? 'none' : 'block';
            document.getElementById('pictureUploadContainer').style.display = readOnly ? 'none' : 'block';
            saveBreakdownBtn.style.display = readOnly ? 'none' : 'inline-flex';

            breakdownModal.style.display = 'flex';
        }

        // Breakdown Form Validation and Submission
        breakdownForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors(breakdownForm);

            let formIsValid = true;
            const formInputs = breakdownForm.querySelectorAll('input[required], select[required], textarea[required]');
            formInputs.forEach(input => {
                if (!validateFormInput(input)) {
                    formIsValid = false;
                }
            });

            if (!formIsValid) {
                showToast('Please correct the errors in the form.', 'error');
                return;
            }

            toggleButtonSpinner(saveBreakdownBtn, saveBreakdownBtnText, saveBreakdownSpinner, true);
            toggleLoadingOverlay(breakdownModalLoadingOverlay, true);

            const breakdownObjectId = document.getElementById('breakdownDocId').value;

            // Upload new files to Back4App
            const finalInvoiceUrls = [];
            const finalPictureUrls = [];

            try {
                // Upload invoices
                for (const fileObj of uploadedInvoices) {
                    if (fileObj.file) {
                        const parseFile = new Parse.File(fileObj.file.name, fileObj.file);
                        await parseFile.save();
                        finalInvoiceUrls.push(parseFile.url());
                    } else if (fileObj.url) {
                        finalInvoiceUrls.push(fileObj.url);
                    }
                }

                // Upload pictures
                for (const fileObj of uploadedPictures) {
                    if (fileObj.file) {
                        const parseFile = new Parse.File(fileObj.file.name, fileObj.file);
                        await parseFile.save();
                        finalPictureUrls.push(parseFile.url());
                    } else if (fileObj.url) {
                        finalPictureUrls.push(fileObj.url);
                    }
                }

                const breakdownData = {
                    caseId: breakdownObjectId ? breakdowns.find(b => b.id === breakdownObjectId).caseId : `BRK-${Math.floor(10000 + Math.random() * 90000)}`,
                    truckNumber: document.getElementById('breakdownTruckNumber').value,
                    trailerNumber: document.getElementById('breakdownTrailerNumber').value,
                    driverName: document.getElementById('breakdownDriverName').value,
                    agentName: document.getElementById('breakdownAgentName').value,
                    makeModel: document.getElementById('breakdownMakeModel').value,
                    storeName: document.getElementById('breakdownStoreName').value,
                    location: document.getElementById('breakdownLocation').value,
                    description: document.getElementById('breakdownDescription').value,
                    status: document.getElementById('breakdownStatus').value,
                    invoices: finalInvoiceUrls,
                    pictures: finalPictureUrls,
                    updatedAt: new Date().toISOString()
                };

                if (!breakdownObjectId) {
                    breakdownData.createdAt = new Date().toISOString();
                }

                if (breakdownObjectId) {
                    const query = new Parse.Query(Breakdown);
                    const breakdownObj = await query.get(breakdownObjectId);
                    breakdownObj.set(breakdownData);
                    await breakdownObj.save();
                    showToast(`Breakdown case ${breakdownData.caseId} updated successfully!`, 'success');
                } else {
                    const breakdownObj = new Breakdown();
                    breakdownObj.set(breakdownData);
                    await breakdownObj.save();
                    showToast('Breakdown case reported successfully!', 'success');
                }

                breakdownModal.style.display = 'none';
                breakdownForm.reset();
                uploadedInvoices = [];
                uploadedPictures = [];
                renderFilePreviews(invoicePreviewContainer, uploadedInvoices, 'invoice');
                renderFilePreviews(picturePreviewContainer, uploadedPictures, 'image');

            } catch (error) {
                console.error("Error saving breakdown:", error);
                showToast('Failed to save breakdown case: ' + error.message, 'error');
            } finally {
                toggleButtonSpinner(saveBreakdownBtn, saveBreakdownBtnText, saveBreakdownSpinner, false);
                toggleLoadingOverlay(breakdownModalLoadingOverlay, false);
            }
        });

        // Add real-time validation on input blur for breakdown form
        breakdownForm.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
            input.addEventListener('blur', () => validateFormInput(input));
            input.addEventListener('input', () => {
                const errorElement = document.getElementById(`${input.id}Error`);
                if (errorElement && input.validity.valid) {
                    input.classList.remove('error');
                    errorElement.textContent = '';
                }
            });
        });

        // --- Route Management (Firestore Integrated) ---

        /**
         * Populates the vehicle select dropdown in the route modal.
         */
        function populateRouteVehicleSelect() {
            routeVehicleIdSelect.innerHTML = '<option value="">Select a Vehicle</option>';
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id; // Store Firestore doc ID as value
                option.textContent = `${vehicle.vehicleId || vehicle.id} - ${vehicle.make} ${vehicle.model}`;
                routeVehicleIdSelect.appendChild(option);
            });
        }

        /**
         * Populates the driver select dropdown in the route modal.
         */
        function populateRouteDriverSelect() {
            routeDriverIdSelect.innerHTML = '<option value="">Select a Driver</option>';
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id; // Store Firestore doc ID as value
                option.textContent = `${driver.driverId || driver.id} - ${driver.name}`;
                routeDriverIdSelect.appendChild(option);
            });
        }

        /**
         * Renders the routes table with the given data.
         * @param {Array} routesToRender - The array of route objects to display.
         */
        function renderRoutesTable(routesToRender) {
            routesTableBody.innerHTML = ''; // Clear existing rows
            if (routesToRender.length === 0) {
                routesTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No routes found.</td></tr>';
                return;
            }

            routesToRender.forEach(route => {
                const row = routesTableBody.insertRow();
                row.setAttribute('data-doc-id', route.id);

                const vehicle = vehicles.find(v => v.id === route.vehicleId);
                const vehicleDisplay = vehicle ? `${vehicle.vehicleId || vehicle.id} (${vehicle.make} ${vehicle.model})` : 'N/A';

                const driver = drivers.find(d => d.id === route.driverId);
                const driverDisplay = driver ? `${driver.name} (${driver.driverId || driver.id})` : 'N/A';

                const statusClass = route.status === 'completed' ? 'active' :
                    route.status === 'in-progress' ? 'maintenance' :
                        route.status === 'scheduled' ? 'info' : 'inactive';

                const statusSelectHtml = `
                    <select class="status-select ${statusClass}" data-doc-id="${route.id}">
                        <option value="scheduled" ${route.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                        <option value="in-progress" ${route.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${route.status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="cancelled" ${route.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                `;

                row.innerHTML = `
                    <td>${route.routeId}</td>
                    <td>${vehicleDisplay}</td>
                    <td>${driverDisplay}</td>
                    <td>${route.origin}</td>
                    <td>${route.destination}</td>
                    <td>${route.scheduledDate}</td>
                    <td>${statusSelectHtml}</td>
                    <td class="action-buttons">
                        <i class="fas fa-edit action-btn" title="Edit Route" data-action="edit"></i>
                        <i class="fas fa-trash action-btn" title="Delete Route" data-action="delete"></i>
                    </td>
                `;
            });
        }

        // Handle route table actions
        routesTableBody.addEventListener('click', handleRouteTableActions);
        routesTableBody.addEventListener('change', handleRouteStatusChange);

        function handleRouteTableActions(event) {
            const target = event.target;
            if (target.classList.contains('action-btn')) {
                const row = target.closest('tr');
                const docId = row.getAttribute('data-doc-id');
                const action = target.getAttribute('data-action');
                const route = routes.find(r => r.id === docId);

                if (!route) {
                    showToast('Route not found!', 'error');
                    return;
                }

                switch (action) {
                    case 'edit':
                        openRouteModalForEdit(route);
                        break;
                    case 'delete':
                        deleteRoute(docId, route.routeId);
                        break;
                }
            }
        }

        async function handleRouteStatusChange(event) {
            const target = event.target;
            if (target.classList.contains('status-select')) {
                const objectId = target.getAttribute('data-doc-id');
                const newStatus = target.value;
                const route = routes.find(r => r.id === objectId);
                const oldStatus = route ? route.status : newStatus;

                try {
                    const query = new Parse.Query(Route);
                    const routeObj = await query.get(objectId);
                    routeObj.set('status', newStatus);
                    await routeObj.save();
                    showToast(`Route status updated to ${newStatus}!`, 'success');
                } catch (error) {
                    console.error("Error updating route status:", error);
                    showToast('Failed to update route status: ' + error.message, 'error');
                    if (route) target.value = oldStatus;
                }
            }
        }

        async function deleteRoute(objectId, routeIdDisplay) {
            const confirmed = await showConfirmation(
                'Delete Route',
                `Are you sure you want to delete route ${routeIdDisplay}? This action cannot be undone.`
            );

            if (confirmed) {
                try {
                    const query = new Parse.Query(Route);
                    const routeObj = await query.get(objectId);
                    await routeObj.destroy();
                    showToast(`Route ${routeIdDisplay} deleted successfully!`, 'success');
                } catch (error) {
                    console.error("Error deleting route:", error);
                    showToast('Failed to delete route: ' + error.message, 'error');
                }
            }
        }

        // Route Search Functionality
        routeSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredRoutes = routes.filter(route => {
                const vehicle = vehicles.find(v => v.id === route.vehicleId);
                const driver = drivers.find(d => d.id === route.driverId);
                const vehicleDisplay = vehicle ? `${vehicle.vehicleId || vehicle.id} ${vehicle.make} ${vehicle.model}` : '';
                const driverDisplay = driver ? `${driver.name} ${driver.driverId || driver.id}` : '';

                return route.routeId.toLowerCase().includes(searchTerm) ||
                    vehicleDisplay.toLowerCase().includes(searchTerm) ||
                    driverDisplay.toLowerCase().includes(searchTerm) ||
                    route.origin.toLowerCase().includes(searchTerm) ||
                    route.destination.toLowerCase().includes(searchTerm) ||
                    route.status.toLowerCase().includes(searchTerm);
            });
            renderRoutesTable(filteredRoutes);
        });

        // --- Add/Edit Route Modal Logic ---
        addRouteBtn.addEventListener('click', () => {
            openRouteModalForAdd();
        });

        function openRouteModalForAdd() {
            routeForm.reset();
            clearFormErrors(routeForm);
            routeModalTitle.textContent = 'Add New Route';
            document.getElementById('routeDocId').value = '';
            document.getElementById('routeId').value = '';
            document.getElementById('routeId').readOnly = false;
            document.getElementById('routeStatus').value = 'scheduled'; // Default status
            populateRouteVehicleSelect(); // Populate dropdown with current vehicles
            populateRouteDriverSelect(); // Populate dropdown with current drivers
            routeModal.style.display = 'flex';
        }

        function openRouteModalForEdit(route) {
            routeForm.reset();
            clearFormErrors(routeForm);
            routeModalTitle.textContent = `Edit Route: ${route.routeId}`;
            document.getElementById('routeDocId').value = route.id;
            document.getElementById('routeId').value = route.routeId;
            document.getElementById('routeId').readOnly = true; // Route ID is read-only when editing

            populateRouteVehicleSelect(); // Populate dropdown first
            document.getElementById('routeVehicleId').value = route.vehicleId;
            populateRouteDriverSelect(); // Populate dropdown first
            document.getElementById('routeDriverId').value = route.driverId;

            document.getElementById('routeOrigin').value = route.origin;
            document.getElementById('routeDestination').value = route.destination;
            document.getElementById('routeScheduledDate').value = route.scheduledDate;
            document.getElementById('routeStatus').value = route.status;
            document.getElementById('routeNotes').value = route.notes || '';

            routeModal.style.display = 'flex';
        }

        // Route Form Validation and Submission
        routeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearFormErrors(routeForm);

            let formIsValid = true;
            const formInputs = routeForm.querySelectorAll('input[required], select[required], textarea[required]');
            formInputs.forEach(input => {
                if (!validateFormInput(input)) {
                    formIsValid = false;
                }
            });

            if (!formIsValid) {
                showToast('Please correct the errors in the form.', 'error');
                return;
            }

            toggleButtonSpinner(saveRouteBtn, saveRouteBtnText, saveRouteSpinner, true);
            toggleLoadingOverlay(routeModalLoadingOverlay, true);

            const routeObjectId = document.getElementById('routeDocId').value;
            const routeData = {
                routeId: routeObjectId ? routes.find(r => r.id === routeObjectId).routeId : `RT-${Math.floor(10000 + Math.random() * 90000)}`,
                vehicleId: document.getElementById('routeVehicleId').value,
                driverId: document.getElementById('routeDriverId').value,
                origin: document.getElementById('routeOrigin').value,
                destination: document.getElementById('routeDestination').value,
                scheduledDate: document.getElementById('routeScheduledDate').value,
                status: document.getElementById('routeStatus').value,
                notes: document.getElementById('routeNotes').value,
                updatedAt: new Date().toISOString()
            };

            if (!routeObjectId) {
                routeData.createdAt = new Date().toISOString();
            }

            try {
                if (routeObjectId) {
                    const query = new Parse.Query(Route);
                    const routeObj = await query.get(routeObjectId);
                    routeObj.set(routeData);
                    await routeObj.save();
                    showToast(`Route ${routeData.routeId} updated successfully!`, 'success');
                } else {
                    const query = new Parse.Query(Route);
                    query.equalTo('routeId', routeData.routeId);
                    const results = await query.find();

                    if (results.length > 0) {
                        showToast(`Route ID ${routeData.routeId} already exists. Please use a unique ID.`, 'error');
                        document.getElementById('routeId').classList.add('error');
                        document.getElementById('routeIdError').textContent = 'This Route ID already exists.';
                        toggleButtonSpinner(saveRouteBtn, saveRouteBtnText, saveRouteSpinner, false);
                        toggleLoadingOverlay(routeModalLoadingOverlay, false);
                        return;
                    }

                    const routeObj = new Route();
                    routeObj.set(routeData);
                    await routeObj.save();
                    showToast('Route added successfully!', 'success');
                }

                routeModal.style.display = 'none';
                routeForm.reset();
            } catch (error) {
                console.error("Error saving route:", error);
                showToast('Failed to save route: ' + error.message, 'error');
            } finally {
                toggleButtonSpinner(saveRouteBtn, saveRouteBtnText, saveRouteSpinner, false);
                toggleLoadingOverlay(routeModalLoadingOverlay, false);
            }
        });

        // Add real-time validation on input blur for route form
        routeForm.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
            input.addEventListener('blur', () => validateFormInput(input));
            input.addEventListener('input', () => {
                const errorElement = document.getElementById(`${input.id}Error`);
                if (errorElement && input.validity.valid) {
                    input.classList.remove('error');
                    errorElement.textContent = '';
                }
            });
        });


        // --- File Upload Logic ---

        /**
         * Handles file selection and updates previews.
         * @param {Event} event - The change event from the file input.
         * @param {Array} fileListArray - The array to store file objects ({file: File, url: string, name: string}).
         * @param {HTMLElement} previewContainer - The DOM element to display previews.
         * @param {string} type - 'invoice' or 'image' for styling.
         */
        function handleFileUpload(event, fileListArray, previewContainer, type) {
            const files = event.target.files;
            for (const file of files) {
                // Check for duplicates by name
                if (!fileListArray.some(f => f.name === file.name)) {
                    fileListArray.push({ file: file, url: null, name: file.name });
                } else {
                    showToast(`File "${file.name}" already added.`, 'warning');
                }
            }
            renderFilePreviews(previewContainer, fileListArray, type);
            event.target.value = ''; // Clear input to allow re-uploading same file if needed
        }

        /**
         * Renders file previews in the specified container.
         * @param {HTMLElement} container - The DOM element to render previews into.
         * @param {Array} filesArray - The array of file objects ({file: File, url: string, name: string}).
         * @param {string} type - 'invoice' or 'image'.
         */
        function renderFilePreviews(container, filesArray, type) {
            container.innerHTML = '';
            filesArray.forEach((fileObj, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.classList.add('file-preview', type);
                previewDiv.setAttribute('data-index', index);

                if (type === 'image' && (fileObj.file || fileObj.url)) {
                    const img = document.createElement('img');
                    img.src = fileObj.url || URL.createObjectURL(fileObj.file);
                    img.alt = fileObj.name;
                    previewDiv.appendChild(img);
                } else {
                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.textContent = fileObj.name;
                    fileNameSpan.style.fontSize = '0.7rem';
                    fileNameSpan.style.textAlign = 'center';
                    fileNameSpan.style.wordBreak = 'break-all';
                    previewDiv.appendChild(fileNameSpan);
                }

                const removeBtn = document.createElement('span');
                removeBtn.classList.add('remove-file');
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFilePreview(filesArray, index, container, type);
                });
                previewDiv.appendChild(removeBtn);

                container.appendChild(previewDiv);
            });
        }

        /**
         * Removes a file preview and its corresponding file from the array.
         * @param {Array} filesArray - The array of file objects.
         * @param {number} index - The index of the file to remove.
         * @param {HTMLElement} container - The preview container.
         * @param {string} type - 'invoice' or 'image'.
         */
        function removeFilePreview(filesArray, index, container, type) {
            filesArray.splice(index, 1);
            renderFilePreviews(container, filesArray, type);
        }

        /**
         * Uploads file to Back4App using Parse File.
         * @param {File} file - The file to upload.
         * @param {string} folder - The storage folder (for naming).
         * @returns {Promise<string>} A promise that resolves with the file URL.
         */
        async function uploadFile(file, folder) {
            const parseFile = new Parse.File(`${Date.now()}_${file.name}`, file);
            await parseFile.save();
            return parseFile.url();
        }

        /**
         * Deletes files from Back4App (handled automatically or via Cloud Code).
         * @param {Array<string>} fileUrls - An array of file URLs to "delete".
         */
        async function deleteFilesFromStorage(fileUrls) {
            // For Back4App, file deletion is handled automatically when objects are deleted
            console.log('File deletion handled by Back4App:', fileUrls);
        }

        /**
         * Extracts file name from a Back4App or Firebase Storage download URL.
         * @param {string} url - The download URL.
         * @returns {string} The file name.
         */
        function getFileNameFromUrl(url) {
            try {
                const decodedUrl = decodeURIComponent(url);
                // Extract path from URL, remove query parameters
                const path = decodedUrl.split('?')[0];
                const parts = path.split('/');
                let fileName = parts[parts.length - 1];
                // Remove timestamp prefix if present (e.g., "1678888888888_filename.pdf")
                const underscoreIndex = fileName.indexOf('_');
                if (underscoreIndex !== -1 && !isNaN(parseInt(fileName.substring(0, underscoreIndex)))) {
                    fileName = fileName.substring(underscoreIndex + 1);
                }
                return fileName;
            } catch (e) {
                console.error("Error parsing file name from URL:", url, e);
                return "unknown_file";
            }
        }


        invoiceUpload.addEventListener('change', (e) => handleFileUpload(e, uploadedInvoices, invoicePreviewContainer, 'invoice'));
        pictureUpload.addEventListener('change', (e) => handleFileUpload(e, uploadedPictures, picturePreviewContainer, 'image'));

        // Drag and drop functionality
        function setupDragAndDrop(containerId, inputId, fileListArray, type) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            container.addEventListener('click', () => input.click());

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.style.borderColor = getCssVariable('primary'); // Corrected
            });

            container.addEventListener('dragleave', (e) => {
                e.preventDefault();
                container.style.borderColor = getCssVariable('light-gray'); // Corrected
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.style.borderColor = getCssVariable('light-gray'); // Corrected
                const files = e.dataTransfer.files;
                for (const file of files) {
                    if (!fileListArray.some(f => f.name === file.name)) {
                        fileListArray.push({ file: file, url: null, name: file.name });
                    } else {
                        showToast(`File "${file.name}" already added.`, 'warning');
                    }
                }
                renderFilePreviews(container, fileListArray, type);
            });
        }

        setupDragAndDrop('invoiceUploadContainer', 'invoiceUpload', uploadedInvoices, 'invoice');
        setupDragAndDrop('pictureUploadContainer', 'pictureUpload', uploadedPictures, 'image');


        // --- Chart.js Integration ---
        let fuelChart; // To store the chart instance

        function renderFuelEfficiencyChart() {
            if (fuelChart) {
                fuelChart.destroy(); // Destroy existing chart before re-rendering
            }

            const ctx = fuelEfficiencyChartCanvas.getContext('2d');
            fuelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fuelData.map(data => data.month),
                    datasets: [{
                        label: 'Average MPG',
                        data: fuelData.map(data => data.efficiency),
                        borderColor: getCssVariable('primary'), /* Use CSS variable */
                        backgroundColor: 'rgba(30, 64, 175, 0.2)', /* Use CSS variable with transparency */
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false,
                            text: 'Fuel Efficiency Over Time'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'MPG'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        // --- Dashboard Upcoming Maintenance ---
        function renderUpcomingMaintenance() {
            upcomingMaintenanceTableBody.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const upcoming = maintenanceRecords
                .filter(record => record.status !== 'completed' && record.status !== 'cancelled')
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 3); // Show top 3 upcoming

            if (upcoming.length === 0) {
                upcomingMaintenanceTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No upcoming maintenance.</td></tr>';
                maintenanceDueStat.textContent = 0;
                return;
            }

            upcoming.forEach(record => {
                const row = upcomingMaintenanceTableBody.insertRow();
                const vehicle = vehicles.find(v => v.id === record.vehicleId);
                const vehicleDisplay = vehicle ? `${vehicle.make} ${vehicle.model} (${vehicle.vehicleId || vehicle.id})` : 'N/A';

                const recordDate = new Date(record.date);
                const isOverdue = recordDate < today;

                const statusClass = isOverdue ? 'inactive' :
                    record.status === 'scheduled' ? 'maintenance' :
                        record.status === 'in-progress' ? 'maintenance' : 'active';

                row.innerHTML = `
                    <td>${vehicleDisplay}</td>
                    <td>${record.serviceType}</td>
                    <td>${record.date}</td>
                    <td>${record.odometer.toLocaleString()} mi</td>
                    <td><span class="status ${statusClass}">${isOverdue ? 'Overdue' : record.status.charAt(0).toUpperCase() + record.status.slice(1)}</span></td>
                    <td class="action-buttons">
                        <i class="fas fa-edit action-btn" title="Edit" data-action="edit-dashboard" data-doc-id="${record.id}"></i>
                        <i class="fas fa-check-circle action-btn" title="Mark Complete" data-action="complete-dashboard" data-doc-id="${record.id}"></i>
                    </td>
                `;
            });

            // Update dashboard stat for maintenance due
            maintenanceDueStat.textContent = maintenanceRecords.filter(record => record.status !== 'completed' && record.status !== 'cancelled').length;
        }

        // Handle actions from the dashboard's upcoming maintenance table
        upcomingMaintenanceTableBody.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('action-btn')) {
                const docId = target.getAttribute('data-doc-id');
                const action = target.getAttribute('data-action');
                const record = maintenanceRecords.find(r => r.id === docId);

                if (!record) {
                    showToast('Maintenance record not found!', 'error');
                    return;
                }

                if (action === 'edit-dashboard') {
                    openMaintenanceModalForEdit(record);
                } else if (action === 'complete-dashboard') {
                    const vehicle = vehicles.find(v => v.id === record.vehicleId);
                    const vehicleDisplay = vehicle ? (vehicle.vehicleId || vehicle.id) : 'N/A';
                    const confirmed = await showConfirmation(
                        'Mark as Complete',
                        `Are you sure you want to mark "${record.serviceType}" for ${vehicleDisplay} as completed?`
                    );
                    if (confirmed) {
                        try {
                            const docRef = window.doc(maintenanceRef, docId);
                            await window.updateDoc(docRef, { status: 'completed' });
                            showToast('Maintenance marked as completed!', 'success');
                        } catch (error) {
                            console.error("Error marking maintenance complete:", error);
                            showToast('Failed to mark maintenance as complete: ' + error.message, 'error');
                        }
                    }
                }
            }
        });

        // --- IMPROVEMENT: Dynamic Dashboard Active Routes ---
        function renderDashboardActiveRoutes() {
            activeRoutesTableBody.innerHTML = ''; // Clear existing
            const activeRoutes = routes.filter(r => r.status === 'in-progress' || r.status === 'scheduled');

            if (activeRoutes.length === 0) {
                activeRoutesTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No active routes.</td></tr>';
                return;
            }

            activeRoutes.forEach(route => {
                const vehicle = vehicles.find(v => v.id === route.vehicleId);
                const driver = drivers.find(d => d.id === route.driverId);

                const vehicleDisplay = vehicle ? `${vehicle.make} ${vehicle.model} (${vehicle.vehicleId || vehicle.id})` : 'N/A';
                const driverDisplay = driver ? driver.name : 'N/A';
                const statusDisplay = route.status.charAt(0).toUpperCase() + route.status.slice(1);

                // Placeholder for dynamic ETA - real ETA calculation would be more complex
                const eta = route.status === 'in-progress' ? 'Calculating...' : '--';

                const statusClass = route.status === 'in-progress' ? 'active' :
                    route.status === 'scheduled' ? 'info' : 'inactive';

                const row = activeRoutesTableBody.insertRow();
                row.innerHTML = `
                    <td>${route.routeId}</td>
                    <td>${driverDisplay}</td>
                    <td>${vehicleDisplay}</td>
                    <td>${route.destination}</td>
                    <td><span class="status ${statusClass}">${statusDisplay}</span></td>
                    <td>${eta}</td>
                `;
            });
        }

        // --- IMPROVEMENT: Dynamic Dashboard Active Breakdowns ---
        function renderDashboardActiveBreakdowns() {
            const activeBreakdownsTableBody = document.getElementById('activeBreakdownsTableBody');
            activeBreakdownsTableBody.innerHTML = ''; // Clear existing
            const activeBreakdowns = breakdowns.filter(b => b.status === 'reported' || b.status === 'in-progress');

            if (activeBreakdowns.length === 0) {
                activeBreakdownsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No active breakdowns.</td></tr>';
                return;
            }

            activeBreakdowns.forEach(breakdown => {
                const statusDisplay = breakdown.status.charAt(0).toUpperCase() + breakdown.status.slice(1);
                const statusClass = breakdown.status === 'reported' ? 'inactive' :
                    breakdown.status === 'in-progress' ? 'maintenance' : 'active';

                const row = activeBreakdownsTableBody.insertRow();
                row.innerHTML = `
                    <td>${breakdown.caseId}</td>
                    <td>${breakdown.truckNumber}</td>
                    <td>${breakdown.driverName}</td>
                    <td>${breakdown.location}</td>
                    <td><span class="status ${statusClass}">${statusDisplay}</span></td>
                `;
            });
        }

        // --- IMPROVEMENT: Dynamic Dashboard Stats ---
        function updateDashboardStats() {
            // Active Trips
            const activeTripsCount = routes.filter(r => r.status === 'in-progress').length;
            activeTripsStat.textContent = activeTripsCount;

            // Fuel Efficiency (using latest from fuelData for now)
            if (fuelData.length > 0) {
                const latestEfficiency = fuelData[fuelData.length - 1].efficiency;
                fuelEfficiencyStat.textContent = latestEfficiency;
            }
            // The 'change' indicators (+/-) would require historical data storage and comparison,
            // which is beyond the scope of client-side only improvements without more data.
        }




        // --- User Selector Functionality ---
        userSelector.addEventListener('change', (event) => {
            const selectedUser = event.target.value;
            const userNames = {
                esteban: 'Esteban',
                albert: 'Albert',
                andrew: 'Andrew'
            };
            const userInitialsMap = {
                esteban: 'E',
                albert: 'A',
                andrew: 'A'
            };
            userName.textContent = userNames[selectedUser];
            userInitials.textContent = userInitialsMap[selectedUser];
        });

        // --- Settings Management ---
        function loadSettings() {
            settings = loadFromLocalStorage(STORAGE_KEYS.settings) || {
                theme: 'light',
                notificationsEnabled: true,
                defaultUser: 'esteban',
                units: 'miles',
                currency: 'USD',
                dateFormat: 'MM/DD/YYYY',
                userName: 'Esteban',
                breakdownIssues: [
                    'Flat tire',
                    'Engine overheating',
                    'Brake failure',
                    'Transmission issue',
                    'Electrical problem',
                    'Fuel system issue',
                    'Cooling system failure',
                    'Suspension damage'
                ].join('\n')
            };
            applySettings();
        }

        function applySettings() {
            // Apply theme
            document.documentElement.setAttribute('data-theme', settings.theme);

            // Apply default user
            userSelector.value = settings.defaultUser;
            userSelector.dispatchEvent(new Event('change'));

            // Update current user name in settings form
            const currentUserNameInput = document.getElementById('currentUserName');
            if (currentUserNameInput) {
                currentUserNameInput.value = settings.userName || 'Esteban';
            }

            // Update breakdown issues list
            renderBreakdownIssuesList();
        }

        function saveSettings() {
            saveToLocalStorage(STORAGE_KEYS.settings, settings);
        }

        function applySettings() {
            // Apply theme
            document.documentElement.setAttribute('data-theme', settings.theme);

            // Apply default user
            userSelector.value = settings.defaultUser;
            userSelector.dispatchEvent(new Event('change'));

            // Update current user name in settings form
            const currentUserNameInput = document.getElementById('currentUserName');
            if (currentUserNameInput) {
                currentUserNameInput.value = settings.userName || 'Esteban';
            }

            // Update breakdown issues list
            renderBreakdownIssuesList();
        }

        // --- Breakdown Issues Management ---
        function renderBreakdownIssuesList() {
            const issuesList = document.getElementById('breakdownIssuesList');
            const issues = settings.breakdownIssues.split('\n').filter(issue => issue.trim() !== '');
            issuesList.innerHTML = '';

            issues.forEach((issue, index) => {
                const issueDiv = document.createElement('div');
                issueDiv.style.display = 'flex';
                issueDiv.style.alignItems = 'center';
                issueDiv.style.marginBottom = '5px';
                issueDiv.style.padding = '5px';
                issueDiv.style.backgroundColor = 'var(--light)';
                issueDiv.style.borderRadius = '4px';

                const issueText = document.createElement('span');
                issueText.textContent = issue;
                issueText.style.flex = '1';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.classList.add('btn');
                removeBtn.style.padding = '2px 8px';
                removeBtn.style.fontSize = '0.8rem';
                removeBtn.style.marginLeft = '10px';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.addEventListener('click', () => removeBreakdownIssue(index));

                issueDiv.appendChild(issueText);
                issueDiv.appendChild(removeBtn);
                issuesList.appendChild(issueDiv);
            });
        }

        function addBreakdownIssue() {
            const newIssue = prompt('Enter a new breakdown issue:');
            if (newIssue && newIssue.trim()) {
                const issues = settings.breakdownIssues.split('\n').filter(issue => issue.trim() !== '');
                issues.push(newIssue.trim());
                settings.breakdownIssues = issues.join('\n');
                saveSettings();
                renderBreakdownIssuesList();
                showToast('Breakdown issue added successfully!', 'success');
            }
        }

        function removeBreakdownIssue(index) {
            const confirmed = confirm('Are you sure you want to remove this breakdown issue?');
            if (confirmed) {
                const issues = settings.breakdownIssues.split('\n').filter(issue => issue.trim() !== '');
                issues.splice(index, 1);
                settings.breakdownIssues = issues.join('\n');
                saveSettings();
                renderBreakdownIssuesList();
                showToast('Breakdown issue removed successfully!', 'success');
            }
        }

        // --- Settings Form Handlers ---
        function setupSettingsForms() {
            // User Preferences Form
            const userPreferencesForm = document.getElementById('userPreferencesForm');
            if (userPreferencesForm) {
                // Load current values
                document.getElementById('themeToggle').value = settings.theme;
                document.getElementById('notificationsEnabled').checked = settings.notificationsEnabled;
                document.getElementById('defaultUser').value = settings.defaultUser;

                userPreferencesForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    settings.theme = document.getElementById('themeToggle').value;
                    settings.notificationsEnabled = document.getElementById('notificationsEnabled').checked;
                    settings.defaultUser = document.getElementById('defaultUser').value;
                    saveSettings();
                    applySettings();
                    showToast('User preferences saved successfully!', 'success');
                });
            }

            // System Settings Form
            const systemSettingsForm = document.getElementById('systemSettingsForm');
            if (systemSettingsForm) {
                // Load current values
                document.getElementById('units').value = settings.units;
                document.getElementById('currency').value = settings.currency;
                document.getElementById('dateFormat').value = settings.dateFormat;
                document.getElementById('breakdownIssues').value = settings.breakdownIssues;

                systemSettingsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    settings.units = document.getElementById('units').value;
                    settings.currency = document.getElementById('currency').value;
                    settings.dateFormat = document.getElementById('dateFormat').value;
                    settings.breakdownIssues = document.getElementById('breakdownIssues').value;
                    saveSettings();
                    renderBreakdownIssuesList(); // Update the list after saving
                    showToast('System settings saved successfully!', 'success');
                });
            }

            // Add Breakdown Issue Button
            const addBreakdownIssueBtn = document.getElementById('addBreakdownIssueBtn');
            if (addBreakdownIssueBtn) {
                addBreakdownIssueBtn.addEventListener('click', addBreakdownIssue);
            }

            // Account Settings Form
            const accountSettingsForm = document.getElementById('accountSettingsForm');
            if (accountSettingsForm) {
                accountSettingsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newUserName = document.getElementById('newUserName').value.trim();
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    if (newPassword !== confirmPassword) {
                        showToast('Passwords do not match!', 'error');
                        return;
                    }

                    if (newUserName) {
                        // Update user name in settings or user data
                        settings.userName = newUserName;
                        saveSettings();
                        document.getElementById('currentUserName').value = newUserName;
                        userName.textContent = newUserName;
                        showToast('User name updated successfully!', 'success');
                    } else {
                        // If no new name provided, keep current
                        settings.userName = settings.userName || 'Esteban';
                    }

                    if (newPassword) {
                        // In a real app, this would update the password securely
                        showToast('Password updated successfully!', 'success');
                    }

                    // Clear form
                    document.getElementById('newUserName').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                });
            }
        }

        // --- Initialization ---
        async function initApp() {
            try {
                // Load settings from localStorage with defaults
                loadSettings();

                // Setup real-time listeners (this will load data from Back4App)
                setupRealtimeListeners();

                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Failed to initialize app: ' + error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            setupSettingsForms(); // Set up form handlers
            switchTab('dashboard'); // Ensure dashboard is active and chart renders
        });
    </script>
</body>

</html>